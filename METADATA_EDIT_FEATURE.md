# 故事元数据编辑功能说明

## 功能概述

该功能允许管理员在后台修改故事的显示作者名和发布时间，方便进行临时性的展示调整。

## 使用步骤

### 1. 运行数据库迁移

首次使用该功能前，需要运行数据库迁移脚本以添加必要的字段：

```bash
python migrate_add_display_metadata.py
```

该脚本会在 `stories` 表中添加 `display_author` 字段。

### 2. 使用编辑功能

1. 登录管理后台（/admin/login）
2. 进入故事管理页面（/admin/stories）
3. 点击任意故事进入详情页面
4. 在右侧边栏找到"作者信息"和"时间线"卡片
5. 点击对应的"编辑"按钮即可修改：
   - **显示作者名**：可输入任意文本作为展示的作者名
   - **发布时间**：可修改故事的发布时间

### 3. 保存修改

- 修改后点击"保存"按钮提交更改
- 修改成功后页面会自动刷新
- 点击"取消"按钮可放弃修改

## 技术实现

### 数据库结构

新增字段：
- `display_author` (VARCHAR(100)): 自定义显示的作者名，如果为NULL则显示真实用户名

### API 端点

- **POST** `/admin/api/update_story_metadata/<story_id>`
  - 参数：
    - `display_author`: 自定义作者名（可选）
    - `published_at`: 发布时间（格式：YYYY-MM-DDTHH:MM）（可选）
  - 响应：JSON格式，包含 `success` 和 `message/error` 字段

### 影响范围

修改后的元数据会在以下页面显示：
- ✅ 管理后台故事列表
- ✅ 管理后台故事详情
- ✅ 管理后台仪表盘
- ✅ 管理后台回收站
- ✅ 前台故事详情页
- ✅ 前台故事库列表

### 数据安全

- 不影响原有的 `user_id` 关联关系
- 不影响用户权限和所有权判断
- 仅修改展示层数据
- 所有修改都会更新 `updated_at` 时间戳

## 注意事项

1. **权限要求**：仅管理员可以使用此功能
2. **数据一致性**：修改的作者名仅用于展示，实际的故事所有者不会改变
3. **历史数据**：已存在的故事 `display_author` 字段为NULL，会自动显示真实用户名
4. **备份建议**：在批量修改前建议备份数据库

## 故障排查

### 问题：编辑按钮不显示
- 检查是否已登录管理后台
- 确认是否在故事详情页面（/admin/story/<id>）

### 问题：保存失败
- 检查网络连接
- 查看浏览器控制台错误信息
- 检查数据库连接是否正常
- 确认 `display_author` 字段是否已添加

### 问题：显示的作者名没有改变
- 刷新页面查看是否已更新
- 检查数据库中 `display_author` 字段的值
- 确认 SQL 查询已使用 `COALESCE(s.display_author, u.username)`

## 版本信息

- 功能添加日期：2025-10-29
- 数据库迁移脚本：`migrate_add_display_metadata.py`
- 影响文件：
  - `app.py` - 后端API和查询逻辑
  - `templates/admin/story_detail.html` - 管理界面
  - `migrate_add_display_metadata.py` - 数据库迁移脚本
