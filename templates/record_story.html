{% extends "base.html" %}

{% block title %}Record Your Story - VoiceVault{% endblock %}

{% block extra_css %}
<style>
/* Modern Audio Player Animations */
@keyframes audioWave {
    0%, 100% { height: 12px; opacity: 0.6; }
    50% { height: 16px; opacity: 1; }
}

@keyframes audioWave2 {
    0%, 100% { height: 16px; opacity: 0.8; }
    50% { height: 20px; opacity: 1; }
}

@keyframes audioWave3 {
    0%, 100% { height: 10px; opacity: 0.5; }
    50% { height: 14px; opacity: 0.8; }
}

@keyframes audioWave4 {
    0%, 100% { height: 14px; opacity: 0.7; }
    50% { height: 18px; opacity: 1; }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes shimmer {
    0% { background-position: -200px 0; }
    100% { background-position: calc(200px + 100%) 0; }
}

/* Static styling - animations removed */
.audio-wave div:nth-child(1) { height: 12px; opacity: 0.6; }
.audio-wave div:nth-child(2) { height: 16px; opacity: 0.8; }
.audio-wave div:nth-child(3) { height: 10px; opacity: 0.5; }
.audio-wave div:nth-child(4) { height: 14px; opacity: 0.7; }

.recorded-story-container {
    /* No animations */
}

.transcription-container {
    /* No animations */
}

.chat-container {
    /* No animations */
}

/* Button styling - no animations */
.btn-modern-primary {
    position: relative;
    overflow: hidden;
}

.btn-modern-secondary {
    position: relative;
    overflow: hidden;
}

/* Progress bar styling - no animations */
.progress-bar {
    position: relative;
    overflow: hidden;
}

/* Responsive design */
@media (max-width: 768px) {
    .recorded-story-container,
    .transcription-container,
    .chat-container {
        padding: 24px !important;
        margin: 0 -15px;
        border-radius: 20px !important;
    }
    
    .action-buttons,
    .transcription-actions {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
    }
    
    .secondary-actions {
        flex-direction: column !important;
        align-items: stretch !important;
    }
    
    .btn-modern-outline {
        text-align: center !important;
    }
    
    .play-btn-modern {
        width: 64px !important;
        height: 64px !important;
        font-size: 1.3rem !important;
    }
    
    .audio-player-container,
    .story-content-container,
    .chat-history-container,
    .chat-input-container {
        padding: 20px !important;
    }
}

@media (max-width: 480px) {
    .recorded-story-container,
    .transcription-container,
    .chat-container {
        padding: 20px !important;
    }
    
    .btn-modern-primary,
    .btn-modern-secondary {
        padding: 14px 20px !important;
        font-size: 0.9rem !important;
    }
    
    .btn-modern-outline {
        padding: 10px 16px !important;
        font-size: 0.85rem !important;
    }
}

/* Loading states */
.btn-loading {
    position: relative;
    color: transparent !important;
}

.btn-loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Focus states for accessibility */
.btn-modern-primary:focus,
.btn-modern-secondary:focus,
.btn-modern-outline:focus,
.play-btn-modern:focus {
    outline: 2px solid var(--warm-primary);
    outline-offset: 2px;
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    .recorded-story-container {
        border: 3px solid var(--warm-primary) !important;
        background: white !important;
    }
    
    .audio-player-container {
        border: 2px solid var(--warm-secondary) !important;
        background: white !important;
    }
}

/* Reduced motion support - no animations to disable */
@media (prefers-reduced-motion: reduce) {
    /* All animations already removed */
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold mb-3" style="color: var(--warm-primary-dark); font-family: 'Georgia', serif;">
                    <i class="fas fa-heart me-3" style="color: var(--warm-primary);"></i>
                    Record Your Story
                </h1>
                <p class="lead" style="color: var(--warm-secondary);">
                    Share your voice, preserve your memories. Your story matters.
                </p>
            </div>

            <!-- Recording Interface -->
            <div class="card" style="border: 2px solid var(--warm-primary-light); background: linear-gradient(145deg, var(--warm-white), #FFF8E1); box-shadow: 0 15px 50px rgba(255, 138, 101, 0.15);">
                <div class="card-body p-5">
                    
                    <!-- Recording Mode Selection -->
                    <div class="mb-4">
                        <label class="form-label fw-bold" style="color: var(--warm-primary-dark);">
                            <i class="fas fa-microphone-alt me-2"></i>Recording Method
                        </label>
                        <div class="btn-group w-100" role="group" id="recordingModeGroup">
                            <input type="radio" class="btn-check" name="recordingMode" id="microphoneMode" value="microphone" checked>
                            <label class="btn btn-outline-primary" for="microphoneMode" style="border-radius: 15px 0 0 15px;">
                                <i class="fas fa-microphone me-2"></i>Use Microphone
                            </label>
                            
                            <input type="radio" class="btn-check" name="recordingMode" id="uploadMode" value="upload">
                            <label class="btn btn-outline-primary" for="uploadMode" style="border-radius: 0 15px 15px 0;">
                                <i class="fas fa-file-upload me-2"></i>Upload Audio File
                            </label>
                        </div>
                    </div>

                    <!-- Language Selection with Search -->
                    <div class="mb-4">
                        <label for="languageSelect" class="form-label fw-bold" style="color: var(--warm-primary-dark);">
                            <i class="fas fa-language me-2"></i>Choose Your Language
                        </label>
                        <div class="position-relative">
                            <div class="language-selector-container" style="border: 2px solid var(--warm-neutral); border-radius: 15px; background: white;">
                                <div class="selected-language p-3 d-flex justify-content-between align-items-center" id="selectedLanguage" style="cursor: pointer;">
                                    <span class="selected-text">
                                        <span class="flag me-2">🇺🇸</span>
                                        <span class="language-name">English (US)</span>
                                    </span>
                                    <i class="fas fa-chevron-down dropdown-arrow"></i>
                                </div>
                                
                                <div class="language-dropdown d-none" id="languageDropdown" style="position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; border: 2px solid var(--warm-neutral); border-top: none; border-radius: 0 0 15px 15px; background: white; max-height: 400px; overflow-y: auto; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                                    
                                    <!-- Search Box -->
                                    <div class="p-3 border-bottom">
                                        <div class="position-relative">
                                            <input type="text" id="languageSearch" class="form-control" placeholder="Search languages..." style="border: 1px solid var(--warm-neutral); border-radius: 8px; padding-left: 35px;">
                                            <i class="fas fa-search position-absolute" style="left: 12px; top: 50%; transform: translateY(-50%); color: var(--warm-secondary);"></i>
                                        </div>
                                    </div>
                                    
                                    <!-- Recent Languages -->
                                    <div class="recent-languages" id="recentLanguages" style="display: none;">
                                        <div class="px-3 py-2" style="background: #f8f9fa; font-size: 0.85rem; font-weight: 600; color: var(--warm-secondary);">
                                            Recently Used
                                        </div>
                                        <div id="recentLanguagesList"></div>
                                    </div>
                                    
                                    <!-- Most Popular Languages -->
                                    <div class="popular-languages" id="popularLanguages">
                                        <div class="px-3 py-2" style="background: #f8f9fa; font-size: 0.85rem; font-weight: 600; color: var(--warm-secondary);">
                                            Most Popular
                                        </div>
                                        <div class="language-option p-3 border-bottom" data-code="en-US" data-name="English (US)" data-flag="🇺🇸" style="cursor: pointer;">
                                            <span class="flag me-2">🇺🇸</span> English (US)
                                        </div>
                                        <div class="language-option p-3 border-bottom" data-code="cmn-Hans-CN" data-name="中文 (Mandarin)" data-flag="🇨🇳" style="cursor: pointer;">
                                            <span class="flag me-2">🇨🇳</span> 中文 (Mandarin)
                                        </div>
                                        <div class="language-option p-3 border-bottom" data-code="es-ES" data-name="Español (Spanish)" data-flag="🇪🇸" style="cursor: pointer;">
                                            <span class="flag me-2">🇪🇸</span> Español (Spanish)
                                        </div>
                                        <div class="language-option p-3 border-bottom" data-code="hi-IN" data-name="हिन्दी (Hindi)" data-flag="🇮🇳" style="cursor: pointer;">
                                            <span class="flag me-2">🇮🇳</span> हिन्दी (Hindi)
                                        </div>
                                        <div class="language-option p-3 border-bottom" data-code="ar-SA" data-name="العربية (Arabic)" data-flag="🇸🇦" style="cursor: pointer;">
                                            <span class="flag me-2">🇸🇦</span> العربية (Arabic)
                                        </div>
                                    </div>
                                    
                                    <!-- All Languages -->
                                    <div class="all-languages" id="allLanguages">
                                        <div class="px-3 py-2" style="background: #f8f9fa; font-size: 0.85rem; font-weight: 600; color: var(--warm-secondary);">
                                            All Languages (55)
                                        </div>
                                        <!-- Languages will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Hidden input for form submission -->
                            <input type="hidden" id="languageSelect" value="en-US">
                        </div>
                    </div>

                    <!-- Microphone Status -->
                    <div class="text-center mb-4">
                        <div id="micStatus" class="alert alert-info" style="border-radius: 15px; display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="micStatusText">Checking microphone...</span>
                        </div>
                    </div>

                    <!-- File Upload Section -->
                    <div id="fileUploadSection" class="mb-4 d-none">
                        <div class="upload-area border-2 border-dashed p-5 text-center" 
                             id="uploadArea" 
                             style="border-color: var(--warm-neutral); border-radius: 20px; background: linear-gradient(145deg, #FFF8E1, #FFFFFF); cursor: pointer; transition: all 0.3s ease;">
                            
                            <div class="upload-content" id="uploadContent">
                                <div class="upload-icon mb-3">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 4rem; color: var(--warm-primary);"></i>
                                </div>
                                <h5 class="mb-3" style="color: var(--warm-primary-dark);">
                                    Drop your audio file here or click to browse
                                </h5>
                                <p class="text-muted mb-3">
                                    Supported formats: MP3, WAV, M4A, MP4, OGG, WEBM<br>
                                    Maximum file size: 10 MB | Maximum duration: 60 minutes
                                </p>
                                <button type="button" class="btn btn-primary" id="browseFileBtn">
                                    <i class="fas fa-folder-open me-2"></i>Browse Files
                                </button>
                            </div>
                            
                            <!-- File Info Display -->
                            <div class="file-info d-none" id="fileInfo">
                                <div class="d-flex align-items-center justify-content-center mb-3">
                                    <div class="file-icon me-3">
                                        <i class="fas fa-file-audio" style="font-size: 3rem; color: var(--warm-success);"></i>
                                    </div>
                                    <div class="file-details text-start">
                                        <h6 class="mb-1" id="fileName" style="color: var(--warm-primary-dark);"></h6>
                                        <div class="file-meta text-muted">
                                            <small id="fileSize"></small> • 
                                            <small id="fileFormat"></small> • 
                                            <small id="fileDuration"></small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- File Preview Player -->
                                <div class="audio-preview mb-3">
                                    <audio id="audioPreview" controls class="w-100" style="border-radius: 15px;">
                                        Your browser does not support the audio element.
                                    </audio>
                                </div>
                                
                                <div class="file-actions">
                                    <button type="button" class="btn btn-success me-2" id="processFileBtn">
                                        <i class="fas fa-magic me-2"></i>开始转录 | Start Transcription
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" id="removeFileBtn">
                                        <i class="fas fa-times me-2"></i>Remove File
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Upload Progress -->
                            <div class="upload-progress d-none" id="uploadProgress">
                                <div class="d-flex align-items-center justify-content-center mb-3">
                                    <div class="spinner-border text-primary me-3" role="status">
                                        <span class="visually-hidden">Uploading...</span>
                                    </div>
                                    <div>
                                        <h6 class="mb-1" style="color: var(--warm-primary-dark);">Uploading...</h6>
                                        <div class="progress" style="width: 200px; height: 8px;">
                                            <div class="progress-bar" id="uploadProgressBar" style="background: var(--warm-primary);" role="progressbar"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden file input -->
                        <input type="file" id="audioFileInput" accept="audio/*,.mp3,.wav,.m4a,.mp4,.ogg,.webm" style="display: none;">
                    </div>

                    <!-- Recording Controls -->
                    <div class="text-center mb-4" id="microphoneSection">
                        <div id="recordingButton" class="d-inline-block">
                            <button id="startRecording" class="btn btn-primary btn-lg" 
                                    style="border-radius: 50%; width: 120px; height: 120px; font-size: 2.5rem; box-shadow: 0 8px 25px rgba(255, 138, 101, 0.3);">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                        
                        <!-- Recording Controls (hidden initially) -->
                        <div id="recordingControls" class="d-none">
                            <button id="pauseRecording" class="btn btn-warning btn-lg me-3" 
                                    style="border-radius: 50%; width: 80px; height: 80px; font-size: 1.5rem;">
                                <i class="fas fa-pause"></i>
                            </button>
                            <button id="stopRecording" class="btn btn-danger btn-lg" 
                                    style="border-radius: 50%; width: 80px; height: 80px; font-size: 1.5rem;">
                                <i class="fas fa-stop"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Recording Status -->
                    <div class="text-center mb-4">
                        <div id="recordingStatus" class="d-none">
                            <div class="d-flex align-items-center justify-content-center mb-3">
                                <div id="recordingIndicator" class="recording-pulse me-3"></div>
                                <span class="fw-bold" style="color: var(--warm-primary-dark); font-size: 1.2rem;">
                                    Recording... <span id="recordingTime">00:00</span>
                                </span>
                            </div>
                        </div>
                        
                        <div id="pausedStatus" class="d-none">
                            <span class="fw-bold" style="color: var(--warm-warning); font-size: 1.2rem;">
                                <i class="fas fa-pause me-2"></i>Paused - <span id="pausedTime">00:00</span>
                            </span>
                        </div>
                    </div>

                    <!-- Audio Visualization -->
                    <div class="text-center mb-4">
                        <canvas id="audioVisualizer" width="600" height="100" 
                                style="border: 2px solid var(--warm-neutral); border-radius: 15px; background: linear-gradient(45deg, #FFF8E1, #FFFFFF); display: none;"></canvas>
                    </div>

                    <!-- Playback Section -->
                    <div id="playbackSection" class="d-none">
                        <div class="recorded-story-container" style="
                            background: linear-gradient(135deg, rgba(255, 248, 225, 0.9) 0%, rgba(255, 255, 255, 0.95) 100%);
                            border: 2px solid rgba(217, 119, 6, 0.2);
                            border-radius: 24px;
                            padding: 32px;
                            box-shadow: 0 20px 60px rgba(217, 119, 6, 0.08), 0 8px 25px rgba(0, 0, 0, 0.06);
                            backdrop-filter: blur(10px);
                            position: relative;
                            overflow: hidden;
                        ">
                            <!-- Decorative background elements -->
                            <div style="
                                position: absolute;
                                top: -20px;
                                right: -20px;
                                width: 120px;
                                height: 120px;
                                background: linear-gradient(45deg, rgba(217, 119, 6, 0.1), rgba(251, 191, 36, 0.1));
                                border-radius: 50%;
                                z-index: 0;
                            "></div>
                            <div style="
                                position: absolute;
                                bottom: -30px;
                                left: -30px;
                                width: 80px;
                                height: 80px;
                                background: linear-gradient(45deg, rgba(16, 163, 74, 0.1), rgba(34, 197, 94, 0.1));
                                border-radius: 50%;
                                z-index: 0;
                            "></div>
                            
                            <!-- Content -->
                            <div style="position: relative; z-index: 1;">
                                <!-- Header -->
                                <div class="text-center mb-4">
                                    <div class="d-inline-flex align-items-center justify-content-center mb-3" style="
                                        width: 64px;
                                        height: 64px;
                                        background: linear-gradient(45deg, var(--warm-success), #22c55e);
                                        border-radius: 20px;
                                        box-shadow: 0 8px 25px rgba(34, 197, 94, 0.25);
                                    ">
                                        <i class="fas fa-microphone" style="font-size: 1.8rem; color: white;"></i>
                                    </div>
                                    <h5 style="
                                        color: var(--warm-primary-dark);
                                        font-family: 'Georgia', serif;
                                        font-weight: 600;
                                        font-size: 1.5rem;
                                        margin-bottom: 8px;
                                        letter-spacing: -0.02em;
                                    ">
                                    Your Recorded Story
                                </h5>
                                    <p style="
                                        color: var(--warm-secondary);
                                        font-size: 0.95rem;
                                        margin-bottom: 0;
                                        opacity: 0.8;
                                    ">
                                        Ready to transform your voice into text
                                    </p>
                                </div>

                                <!-- Audio Player -->
                                <div class="audio-player-container mb-4" style="
                                    background: rgba(255, 255, 255, 0.7);
                                    border: 1px solid rgba(217, 119, 6, 0.15);
                                    border-radius: 20px;
                                    padding: 24px;
                                    backdrop-filter: blur(5px);
                                ">
                                    <div class="d-flex align-items-center">
                                        <!-- Play Button -->
                                        <button id="playButton" class="play-btn-modern me-4" style="
                                            width: 72px;
                                            height: 72px;
                                            border-radius: 50%;
                                            border: none;
                                            background: linear-gradient(45deg, var(--warm-success), #22c55e);
                                            color: white;
                                            font-size: 1.5rem;
                                            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
                                            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            position: relative;
                                            overflow: hidden;
                                        " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 12px 35px rgba(34, 197, 94, 0.4)'" 
                                           onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 8px 25px rgba(34, 197, 94, 0.3)'">
                                            <i class="fas fa-play" style="margin-left: 3px;"></i>
                                    </button>
                                        
                                        <!-- Progress Area -->
                                        <div class="flex-grow-1" style="min-width: 0;">
                                            <!-- Waveform-style progress bar -->
                                            <div class="progress-container mb-2" style="position: relative;">
                                                <div class="progress" style="
                                                    height: 12px;
                                                    border-radius: 8px;
                                                    background: rgba(217, 119, 6, 0.1);
                                                    overflow: hidden;
                                                    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
                                                ">
                                                    <div id="progressBar" class="progress-bar" style="
                                                        background: linear-gradient(90deg, var(--warm-success), #22c55e);
                                                        border-radius: 8px;
                                                        transition: width 0.1s ease;
                                                        box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
                                                    " role="progressbar"></div>
                                        </div>
                                        </div>
                                            
                                            <!-- Time Display -->
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span id="currentTime" style="
                                                    font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
                                                    color: var(--warm-primary-dark);
                                                    font-size: 0.9rem;
                                                    font-weight: 600;
                                                ">00:00</span>
                                                
                                                <div class="audio-status" style="
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 8px;
                                                    color: var(--warm-secondary);
                                                    font-size: 0.85rem;
                                                ">
                                                    <div class="audio-wave" style="
                                                        display: flex;
                                                        align-items: center;
                                                        gap: 2px;
                                                    ">
                                                        <div style="width: 3px; height: 12px; background: var(--warm-success); border-radius: 2px; opacity: 0.6;"></div>
                                                        <div style="width: 3px; height: 16px; background: var(--warm-success); border-radius: 2px; opacity: 0.8;"></div>
                                                        <div style="width: 3px; height: 10px; background: var(--warm-success); border-radius: 2px; opacity: 0.5;"></div>
                                                        <div style="width: 3px; height: 14px; background: var(--warm-success); border-radius: 2px; opacity: 0.7;"></div>
                                    </div>
                                                    <span>Audio Ready</span>
                                </div>

                                                <span id="totalTime" style="
                                                    font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
                                                    color: var(--warm-secondary);
                                                    font-size: 0.9rem;
                                                    font-weight: 500;
                                                ">Infinity:NaN</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="action-buttons" style="
                                    display: grid;
                                    grid-template-columns: 1fr 1fr;
                                    gap: 16px;
                                    margin-bottom: 20px;
                                ">
                                    <!-- Primary Action -->
                                    <button id="startTranscription" class="btn-modern-primary" style="
                                        background: linear-gradient(135deg, var(--warm-success) 0%, #22c55e 100%);
                                        border: none;
                                        border-radius: 16px;
                                        padding: 16px 24px;
                                        color: white;
                                        font-weight: 600;
                                        font-size: 1rem;
                                        box-shadow: 0 8px 25px rgba(34, 197, 94, 0.25);
                                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                        position: relative;
                                        overflow: hidden;
                                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 35px rgba(34, 197, 94, 0.35)'" 
                                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(34, 197, 94, 0.25)'">
                                        <i class="fas fa-magic me-2"></i>
                                        <span>开始Google识别 | Start Google Recognition</span>
                                    </button>
                                    
                                    <!-- Save Audio -->
                                    <button id="saveRecording" class="btn-modern-secondary" style="
                                        background: linear-gradient(135deg, var(--warm-primary) 0%, var(--warm-primary-light) 100%);
                                        border: none;
                                        border-radius: 16px;
                                        padding: 16px 24px;
                                        color: white;
                                        font-weight: 600;
                                        font-size: 1rem;
                                        box-shadow: 0 8px 25px rgba(217, 119, 6, 0.25);
                                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 35px rgba(217, 119, 6, 0.35)'" 
                                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(217, 119, 6, 0.25)'">
                                        <i class="fas fa-save me-2"></i>
                                        <span>仅保存录音 | Save Audio Only</span>
                                    </button>
                                </div>
                                
                                <!-- Secondary Actions -->
                                <div class="secondary-actions" style="
                                    display: flex;
                                    justify-content: center;
                                    gap: 12px;
                                    flex-wrap: wrap;
                                ">
                                    <button id="discardRecording" class="btn-modern-outline" style="
                                        background: rgba(239, 68, 68, 0.1);
                                        border: 2px solid rgba(239, 68, 68, 0.2);
                                        border-radius: 12px;
                                        padding: 12px 20px;
                                        color: #dc2626;
                                        font-weight: 500;
                                        font-size: 0.9rem;
                                        transition: all 0.3s ease;
                                    " onmouseover="this.style.background='rgba(239, 68, 68, 0.15)'; this.style.borderColor='rgba(239, 68, 68, 0.3)'" 
                                       onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'; this.style.borderColor='rgba(239, 68, 68, 0.2)'">
                                        <i class="fas fa-trash me-2"></i>
                                        丢弃 | Discard
                                    </button>
                                    <button id="recordAgain" class="btn-modern-outline" style="
                                        background: rgba(217, 119, 6, 0.1);
                                        border: 2px solid rgba(217, 119, 6, 0.2);
                                        border-radius: 12px;
                                        padding: 12px 20px;
                                        color: var(--warm-primary-dark);
                                        font-weight: 500;
                                        font-size: 0.9rem;
                                        transition: all 0.3s ease;
                                    " onmouseover="this.style.background='rgba(217, 119, 6, 0.15)'; this.style.borderColor='rgba(217, 119, 6, 0.3)'" 
                                       onmouseout="this.style.background='rgba(217, 119, 6, 0.1)'; this.style.borderColor='rgba(217, 119, 6, 0.2)'">
                                        <i class="fas fa-redo me-2"></i>
                                        重新录制 | Record Again
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Transcription Section -->
                    <div id="transcriptionSection" class="d-none mt-4">
                        <div class="transcription-container" style="
                            background: linear-gradient(135deg, rgba(224, 242, 254, 0.9) 0%, rgba(255, 255, 255, 0.95) 100%);
                            border: 2px solid rgba(14, 165, 233, 0.2);
                            border-radius: 24px;
                            padding: 32px;
                            box-shadow: 0 20px 60px rgba(14, 165, 233, 0.08), 0 8px 25px rgba(0, 0, 0, 0.06);
                            backdrop-filter: blur(10px);
                            position: relative;
                            overflow: hidden;
                        ">
                            <!-- Decorative background elements -->
                            <div style="
                                position: absolute;
                                top: -20px;
                                right: -20px;
                                width: 120px;
                                height: 120px;
                                background: linear-gradient(45deg, rgba(14, 165, 233, 0.1), rgba(56, 189, 248, 0.1));
                                border-radius: 50%;
                                z-index: 0;
                            "></div>
                            <div style="
                                position: absolute;
                                bottom: -30px;
                                left: -30px;
                                width: 80px;
                                height: 80px;
                                background: linear-gradient(45deg, rgba(168, 85, 247, 0.1), rgba(192, 132, 252, 0.1));
                                border-radius: 50%;
                                z-index: 0;
                            "></div>
                            
                            <!-- Content -->
                            <div style="position: relative; z-index: 1;">
                                <!-- Header -->
                                <div class="text-center mb-4">
                                    <div class="d-inline-flex align-items-center justify-content-center mb-3" style="
                                        width: 64px;
                                        height: 64px;
                                        background: linear-gradient(45deg, var(--warm-info), #38bdf8);
                                        border-radius: 20px;
                                        box-shadow: 0 8px 25px rgba(14, 165, 233, 0.25);
                                    ">
                                        <i class="fas fa-file-alt" style="font-size: 1.8rem; color: white;"></i>
                                    </div>
                                    <h5 style="
                                        color: var(--warm-primary-dark);
                                        font-family: 'Georgia', serif;
                                        font-weight: 600;
                                        font-size: 1.5rem;
                                        margin-bottom: 8px;
                                        letter-spacing: -0.02em;
                                    ">
                                    故事转录 | Story Transcription
                                </h5>
                                    <p style="
                                        color: var(--warm-secondary);
                                        font-size: 0.95rem;
                                        margin-bottom: 0;
                                        opacity: 0.8;
                                    ">
                                        Transform your voice into beautiful text
                                    </p>
                                </div>
                                
                                <div id="transcriptionLoading" class="text-center py-4 d-none">
                                    <div class="spinner-border" style="color: var(--warm-info);" role="status">
                                        <span class="visually-hidden">Transcribing...</span>
                                    </div>
                                    <p class="mt-3 mb-0" style="color: var(--warm-secondary);">
                                        <i class="fas fa-magic me-2"></i>
                                        正在将您的声音转换为文字... | Converting your voice to text...
                                    </p>
                                </div>
                                
                                <div id="transcriptionResult" class="d-none">
                                    <!-- Polished Story Display -->
                                    <div class="mb-4">
                                        <div class="story-content-container" style="
                                            background: rgba(255, 255, 255, 0.7);
                                            border: 1px solid rgba(217, 119, 6, 0.15);
                                            border-radius: 20px;
                                            padding: 24px;
                                            backdrop-filter: blur(5px);
                                            margin-bottom: 20px;
                                        ">
                                            <div class="d-flex align-items-center mb-3">
                                                <div class="d-inline-flex align-items-center justify-content-center me-3" style="
                                                    width: 48px;
                                                    height: 48px;
                                                    background: linear-gradient(45deg, var(--warm-accent), #f59e0b);
                                                    border-radius: 16px;
                                                    box-shadow: 0 6px 20px rgba(245, 158, 11, 0.25);
                                                ">
                                                    <i class="fas fa-magic" style="font-size: 1.2rem; color: rgb(70, 0, 247);"></i>
                                                </div>
                                                <div>
                                                    <h6 style="
                                                        color: var(--warm-primary-dark);
                                                        font-weight: 600;
                                                        margin-bottom: 4px;
                                                        font-size: 1.1rem;
                                                    ">
                                                        润色后的故事 | Your Polished Story
                                                    </h6>
                                                    <p style="
                                                        color: var(--warm-secondary);
                                                        font-size: 0.85rem;
                                                        margin-bottom: 0;
                                                        opacity: 0.8;
                                                    ">
                                                        <i class="fas fa-edit me-1"></i>
                                                        您可以直接编辑润色后的故事 | You can edit the polished story directly
                                                    </p>
                                                </div>
                                            </div>
                                            
                                            <div class="story-text-area" style="
                                                background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
                                                border: 2px solid rgba(217, 119, 6, 0.1);
                                                border-radius: 16px;
                                                padding: 20px;
                                                margin-bottom: 16px;
                                            ">
                                                <div id="polishedStoryText" 
                                                     style="
                                                        min-height: 120px; 
                                                        line-height: 1.6; 
                                                        font-size: 1.1rem; 
                                                        color: var(--warm-primary-dark); 
                                                        white-space: pre-wrap;
                                                        border: none;
                                                        outline: none;
                                                        font-family: 'Georgia', serif;
                                                     "
                                                     contenteditable="true"></div>
                                            </div>
                                            
                                            <div class="story-meta" style="
                                                background: rgba(255,255,255,0.7); 
                                                border-radius: 12px; 
                                                padding: 12px 16px;
                                                border: 1px solid rgba(217, 119, 6, 0.1);
                                            ">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <small class="text-muted d-flex align-items-center">
                                                        <i class="fas fa-robot me-2" style="color: var(--warm-accent);"></i>
                                                        由 <span id="geminiModelUsed" class="fw-semibold">Gemini AI</span> 润色 | Polished by <span id="geminiModelUsedEn" class="fw-semibold">Gemini AI</span>
                                                    </small>
                                                    <span id="polishedIndicator" class="badge" style="
                                                        background: linear-gradient(45deg, var(--warm-success), #22c55e);
                                                        color: white;
                                                        padding: 6px 12px;
                                                        border-radius: 8px;
                                                        font-size: 0.75rem;
                                                        font-weight: 500;
                                                    ">
                                                            <i class="fas fa-check me-1"></i>已润色 | Polished
                                                        </span>
                                                </div>
                                                <div id="confidenceScore" class="mt-1"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Publish Story Button -->
                                        <div class="text-center">
                                            <button id="publishStoryBtn" class="btn-modern-primary" onclick="goToPublish()" style="
                                                background: linear-gradient(135deg, var(--warm-primary) 0%, var(--warm-primary-light) 100%);
                                                border: none;
                                                border-radius: 16px;
                                                padding: 16px 32px;
                                                color: white;
                                                font-weight: 600;
                                                font-size: 1rem;
                                                box-shadow: 0 8px 25px rgba(217, 119, 6, 0.25);
                                                display: none;
                                            ">
                                                <i class="fas fa-paper-plane me-2"></i>
                                                发布我的故事 | Publish My Story
                                            </button>
                                            <small class="d-block mt-2 text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                完善故事信息并分享给更多读者 | Complete story details and share with readers
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <!-- Raw Transcription (Collapsible) -->
                                    <div class="mb-3">
                                        <div class="d-flex align-items-center">
                                            <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#rawTranscriptionCollapse" aria-expanded="false">
                                                <i class="fas fa-eye me-2"></i>查看原始转录 | View Raw Transcription
                                            </button>
                                        </div>
                                        <div class="collapse mt-2" id="rawTranscriptionCollapse">
                                            <div class="card card-body" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                                                <small class="text-muted mb-2">原始转录文本 | Original Transcribed Text:</small>
                                                <div id="rawTranscriptionText" style="font-family: monospace; font-size: 0.9rem; color: #6c757d;"></div>
                                            </div>
                                        </div>
                                    </div>
                                    

                                    
                                    <!-- Story Polish Chat Interface -->
                                    <div id="storyPolishChat" class="mb-4">
                                        <div class="chat-container" style="
                                            background: linear-gradient(135deg, rgba(232, 244, 253, 0.9) 0%, rgba(255, 255, 255, 0.95) 100%);
                                            border: 2px solid rgba(245, 158, 11, 0.2);
                                            border-radius: 24px;
                                            padding: 32px;
                                            box-shadow: 0 20px 60px rgba(245, 158, 11, 0.08), 0 8px 25px rgba(0, 0, 0, 0.06);
                                            backdrop-filter: blur(10px);
                                            position: relative;
                                            overflow: hidden;
                                        ">
                                            <!-- Decorative background elements -->
                                            <div style="
                                                position: absolute;
                                                top: -20px;
                                                right: -20px;
                                                width: 120px;
                                                height: 120px;
                                                background: linear-gradient(45deg, rgba(245, 158, 11, 0.1), rgba(251, 191, 36, 0.1));
                                                border-radius: 50%;
                                                z-index: 0;
                                            "></div>
                                            <div style="
                                                position: absolute;
                                                bottom: -30px;
                                                left: -30px;
                                                width: 80px;
                                                height: 80px;
                                                background: linear-gradient(45deg, rgba(79, 195, 247, 0.1), rgba(129, 140, 248, 0.1));
                                                border-radius: 50%;
                                                z-index: 0;
                                            "></div>
                                            
                                            <!-- Content -->
                                            <div style="position: relative; z-index: 1;">
                                                <!-- Header -->
                                                <div class="text-center mb-4">
                                                    <div class="d-inline-flex align-items-center justify-content-center mb-3" style="
                                                        width: 64px;
                                                        height: 64px;
                                                        background: linear-gradient(45deg, var(--warm-accent), #4fc3f7);
                                                        border-radius: 20px;
                                                        box-shadow: 0 8px 25px rgba(245, 158, 11, 0.25);
                                                    ">
                                                        <i class="fas fa-comments" style="font-size: 1.8rem; color: white;"></i>
                                                    </div>
                                                    <h5 style="
                                                        color: var(--warm-primary-dark);
                                                        font-family: 'Georgia', serif;
                                                        font-weight: 600;
                                                        font-size: 1.5rem;
                                                        margin-bottom: 8px;
                                                        letter-spacing: -0.02em;
                                                    ">
                                                    与AI对话继续润色 | Chat with AI to Polish Further
                                                    </h5>
                                                    <p style="
                                                        color: var(--warm-secondary);
                                                        font-size: 0.95rem;
                                                        margin-bottom: 0;
                                                        opacity: 0.8;
                                                    ">
                                                        Collaborate with AI to perfect your story
                                                    </p>
                                            </div>
                                                
                                                <!-- Chat History -->
                                                <div class="chat-history-container mb-4" style="
                                                    background: rgba(255, 255, 255, 0.7);
                                                    border: 1px solid rgba(245, 158, 11, 0.15);
                                                    border-radius: 20px;
                                                    padding: 24px;
                                                    backdrop-filter: blur(5px);
                                                ">
                                                    <div id="chatHistory" style="
                                                        max-height: 300px; 
                                                        overflow-y: auto; 
                                                        border-radius: 16px; 
                                                        padding: 20px; 
                                                        background: linear-gradient(135deg, #fafafa 0%, #ffffff 100%);
                                                        border: 2px solid rgba(245, 158, 11, 0.1);
                                                    ">
                                                                                                            <div class="text-center text-muted" id="chatPlaceholder">
                                                            <div class="d-inline-flex align-items-center justify-content-center mb-3" style="
                                                                width: 56px;
                                                                height: 56px;
                                                                background: linear-gradient(45deg, var(--warm-primary), var(--warm-primary-light));
                                                                border-radius: 18px;
                                                                box-shadow: 0 6px 20px rgba(217, 119, 6, 0.25);
                                                            ">
                                                                <i class="fas fa-robot" style="font-size: 1.5rem; color: white;"></i>
                                                            </div>
                                                            <p class="mb-0" style="color: var(--warm-secondary); font-size: 0.95rem;">
                                                                开始与AI对话来改进您的故事<br>Start chatting with AI to improve your story
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Chat Input -->
                                                <div class="chat-input-container" style="
                                                    background: rgba(255, 255, 255, 0.7);
                                                    border: 1px solid rgba(245, 158, 11, 0.15);
                                                    border-radius: 20px;
                                                    padding: 20px;
                                                    backdrop-filter: blur(5px);
                                                ">
                                                    <div class="input-group" style="border-radius: 16px; overflow: hidden;">
                                                        <textarea id="chatInput" class="form-control" rows="2" 
                                                                  placeholder="输入您的想法或请求... | Enter your thoughts or requests..."
                                                                  style="
                                                                    border: 2px solid rgba(245, 158, 11, 0.2); 
                                                                    border-radius: 16px 0 0 16px; 
                                                                    resize: none;
                                                                    background: white;
                                                                    font-size: 0.95rem;
                                                                    padding: 12px 16px;
                                                                  "></textarea>
                                                        <button id="sendChatMessage" class="btn" style="
                                                            border-radius: 0 16px 16px 0; 
                                                            background: linear-gradient(45deg, var(--warm-accent), #4fc3f7); 
                                                            border: 2px solid rgba(245, 158, 11, 0.2);
                                                            border-left: none;
                                                            color: white;
                                                            padding: 12px 20px;
                                                            font-size: 1.1rem;
                                                        ">
                                                            <i class="fas fa-paper-plane"></i>
                                                        </button>
                                                    </div>
                                                    <div class="form-text mt-2" style="padding-left: 4px;">
                                                        <small class="text-muted">
                                                            <i class="fas fa-lightbulb me-1" style="color: var(--warm-accent);"></i>
                                                            示例：「让故事更生动」「添加对话」「改进结尾」 | Examples: "Make it more vivid", "Add dialogue", "Improve the ending"
                                                        </small>
                                                    </div>
                                                </div>
                                                
                                                <!-- Chat Loading -->
                                                <div id="chatLoading" class="d-none mt-3">
                                                    <div class="d-flex align-items-center justify-content-center" style="
                                                        background: rgba(245, 158, 11, 0.1);
                                                        border: 1px solid rgba(245, 158, 11, 0.2);
                                                        border-radius: 16px;
                                                        padding: 16px;
                                                    ">
                                                        <div class="spinner-border spinner-border-sm me-3" style="color: var(--warm-accent);" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                        <small style="color: var(--warm-primary-dark); font-weight: 500;">AI正在思考... | AI is thinking...</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="transcription-actions" style="
                                        display: grid;
                                        grid-template-columns: 1fr 1fr;
                                        gap: 16px;
                                        margin-top: 24px;
                                    ">
                                        <button id="savePolishedStory" class="btn-modern-primary" style="
                                            background: linear-gradient(135deg, var(--warm-success) 0%, #22c55e 100%);
                                            border: none;
                                            border-radius: 16px;
                                            padding: 16px 24px;
                                            color: white;
                                            font-weight: 600;
                                            font-size: 1rem;
                                            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.25);
                                        ">
                                            <i class="fas fa-save me-2"></i>
                                            <span>保存润色故事 | Save Polished Story</span>
                                        </button>
                                        <button id="retranscribe" class="btn-modern-outline" style="
                                            background: rgba(14, 165, 233, 0.1);
                                            border: 2px solid rgba(14, 165, 233, 0.2);
                                            border-radius: 16px;
                                            padding: 16px 24px;
                                            color: var(--warm-info);
                                            font-weight: 600;
                                            font-size: 1rem;
                                        ">
                                            <i class="fas fa-redo me-2"></i>
                                            <span>重新转录 | Transcribe Again</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="transcriptionError" class="d-none">
                                    <div class="error-container" style="
                                        background: rgba(239, 68, 68, 0.1);
                                        border: 2px solid rgba(239, 68, 68, 0.2);
                                        border-radius: 20px;
                                        padding: 24px;
                                        text-align: center;
                                    ">
                                        <div class="d-inline-flex align-items-center justify-content-center mb-3" style="
                                            width: 56px;
                                            height: 56px;
                                            background: linear-gradient(45deg, #dc2626, #ef4444);
                                            border-radius: 18px;
                                            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.25);
                                        ">
                                            <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; color: white;"></i>
                                    </div>
                                        <p style="color: #dc2626; font-weight: 500; margin-bottom: 20px; font-size: 1rem;">
                                            <span id="transcriptionErrorText">转录失败，请重试 | Transcription failed. Please try again.</span>
                                        </p>
                                        <button id="retryTranscription" class="btn-modern-outline" style="
                                            background: rgba(239, 68, 68, 0.1);
                                            border: 2px solid rgba(239, 68, 68, 0.3);
                                            border-radius: 16px;
                                            padding: 12px 24px;
                                            color: #dc2626;
                                            font-weight: 500;
                                            font-size: 0.95rem;
                                        ">
                                            <i class="fas fa-redo me-2"></i>重试 | Try Again
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="mt-4 p-4" style="background: linear-gradient(45deg, var(--warm-background), var(--warm-white)); border-radius: 15px; border: 1px solid var(--warm-neutral);">
                        <h6 class="fw-bold mb-3" style="color: var(--warm-primary-dark);">
                            <i class="fas fa-lightbulb me-2" style="color: var(--warm-warning);"></i>
                            Recording Tips
                        </h6>
                        <ul class="mb-0" style="color: var(--warm-secondary);">
                            <li>Find a quiet space for the best audio quality</li>
                            <li>Speak clearly and at a comfortable pace</li>
                            <li>Keep your device close but not too close to avoid distortion</li>
                            <li>You can pause and resume your recording anytime</li>
                            <li>Review your recording before saving</li>
                            <li><strong>Your story will be automatically transcribed after recording</strong></li>
                        </ul>
                    </div>
                </div>
            </div>



            <!-- Back to Dashboard -->
            <div class="text-center mt-4">
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-2"></i>Back to My Stories
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Permission Modal -->
<div class="modal fade" id="permissionModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px; border: 2px solid var(--warm-primary-light);">
            <div class="modal-header" style="background: linear-gradient(45deg, var(--warm-primary), var(--warm-primary-dark)); color: white; border-radius: 18px 18px 0 0;">
                <h5 class="modal-title">
                    <i class="fas fa-microphone me-2"></i>Microphone Permission Required
                </h5>
            </div>
            <div class="modal-body text-center p-4">
                <div class="mb-4">
                    <i class="fas fa-microphone" style="font-size: 4rem; color: var(--warm-primary);"></i>
                </div>
                <h6 class="fw-bold mb-3">We need access to your microphone to record your story</h6>
                <p class="text-muted mb-4">
                    Please click "Allow" when your browser asks for microphone permission. 
                    Your privacy is important to us - we only record when you press the record button.
                </p>
                <button id="requestPermission" class="btn btn-primary btn-lg">
                    <i class="fas fa-microphone me-2"></i>Grant Microphone Access
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px;">
            <div class="modal-header bg-danger text-white" style="border-radius: 18px 18px 0 0;">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Recording Error
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
                <i class="fas fa-exclamation-circle text-danger" style="font-size: 3rem;"></i>
                <h6 class="fw-bold mt-3 mb-3">Something went wrong</h6>
                <p id="errorMessage" class="text-muted mb-4"></p>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="fas fa-refresh me-2"></i>Try Again
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
class VoiceRecorder {
    constructor() {
        this.mediaRecorder = null;
        this.audioChunks = [];
        this.recordedBlob = null;
        this.audioContext = null;
        this.analyser = null;
        this.microphone = null;
        this.startTime = null;
        this.pausedDuration = 0;
        this.isPaused = false;
        this.timerInterval = null;
        this.animationFrame = null;
        this.selectedLanguage = 'en-US';
        this.recentLanguages = this.getRecentLanguages();
        this.recordingMode = 'microphone';
        this.uploadedFile = null;
        this.maxFileSize = 10 * 1024 * 1024; // 10MB
        this.supportedFormats = ['mp3', 'wav', 'm4a', 'mp4', 'ogg', 'webm', 'flac'];
        this.maxSyncDuration = 59; // seconds for synchronous API
        this.chunkDuration = 50; // seconds per chunk (safe buffer for Google API)
        this.maxAsyncDuration = 600; // 10 minutes for async API
        this.audioChunks = [];
        this.transcriptionResults = [];
        
        // Complete list of 55 supported languages
        this.allLanguages = [
            // Most Popular (Top 10)
            { code: 'en-US', name: 'English (US)', flag: '🇺🇸', popular: true },
            { code: 'cmn-Hans-CN', name: '中文 (Mandarin)', flag: '🇨🇳', popular: true },
            { code: 'es-ES', name: 'Español (Spanish)', flag: '🇪🇸', popular: true },
            { code: 'hi-IN', name: 'हिन्दी (Hindi)', flag: '🇮🇳', popular: true },
            { code: 'ar-SA', name: 'العربية (Arabic)', flag: '🇸🇦', popular: true },
            { code: 'pt-BR', name: 'Português (Portuguese)', flag: '🇧🇷', popular: true },
            { code: 'ru-RU', name: 'Русский (Russian)', flag: '🇷🇺', popular: true },
            { code: 'ja-JP', name: '日本語 (Japanese)', flag: '🇯🇵', popular: true },
            { code: 'fr-FR', name: 'Français (French)', flag: '🇫🇷', popular: true },
            { code: 'de-DE', name: 'Deutsch (German)', flag: '🇩🇪', popular: true },
            
            // European Languages
            { code: 'en-GB', name: 'English (UK)', flag: '🇬🇧' },
            { code: 'es-MX', name: 'Español (Mexico)', flag: '🇲🇽' },
            { code: 'fr-CA', name: 'Français (Canada)', flag: '🇨🇦' },
            { code: 'it-IT', name: 'Italiano (Italian)', flag: '🇮🇹' },
            { code: 'nl-NL', name: 'Nederlands (Dutch)', flag: '🇳🇱' },
            { code: 'pl-PL', name: 'Polski (Polish)', flag: '🇵🇱' },
            { code: 'sv-SE', name: 'Svenska (Swedish)', flag: '🇸🇪' },
            { code: 'no-NO', name: 'Norsk (Norwegian)', flag: '🇳🇴' },
            { code: 'da-DK', name: 'Dansk (Danish)', flag: '🇩🇰' },
            { code: 'fi-FI', name: 'Suomi (Finnish)', flag: '🇫🇮' },
            { code: 'cs-CZ', name: 'Čeština (Czech)', flag: '🇨🇿' },
            { code: 'hu-HU', name: 'Magyar (Hungarian)', flag: '🇭🇺' },
            { code: 'ro-RO', name: 'Română (Romanian)', flag: '🇷🇴' },
            { code: 'bg-BG', name: 'Български (Bulgarian)', flag: '🇧🇬' },
            { code: 'hr-HR', name: 'Hrvatski (Croatian)', flag: '🇭🇷' },
            { code: 'sk-SK', name: 'Slovenčina (Slovak)', flag: '🇸🇰' },
            { code: 'sl-SI', name: 'Slovenščina (Slovenian)', flag: '🇸🇮' },
            { code: 'et-EE', name: 'Eesti (Estonian)', flag: '🇪🇪' },
            { code: 'lv-LV', name: 'Latviešu (Latvian)', flag: '🇱🇻' },
            { code: 'lt-LT', name: 'Lietuvių (Lithuanian)', flag: '🇱🇹' },
            
            // Asian Languages
            { code: 'ko-KR', name: '한국어 (Korean)', flag: '🇰🇷' },
            { code: 'th-TH', name: 'ไทย (Thai)', flag: '🇹🇭' },
            { code: 'vi-VN', name: 'Tiếng Việt (Vietnamese)', flag: '🇻🇳' },
            { code: 'id-ID', name: 'Bahasa Indonesia', flag: '🇮🇩' },
            { code: 'ms-MY', name: 'Bahasa Malaysia', flag: '🇲🇾' },
            { code: 'fil-PH', name: 'Filipino', flag: '🇵🇭' },
            { code: 'bn-BD', name: 'বাংলা (Bengali)', flag: '🇧🇩' },
            { code: 'ta-IN', name: 'தமிழ் (Tamil)', flag: '🇮🇳' },
            { code: 'te-IN', name: 'తెలుగు (Telugu)', flag: '🇮🇳' },
            { code: 'mr-IN', name: 'मराठी (Marathi)', flag: '🇮🇳' },
            { code: 'gu-IN', name: 'ગુજરાતી (Gujarati)', flag: '🇮🇳' },
            { code: 'kn-IN', name: 'ಕನ್ನಡ (Kannada)', flag: '🇮🇳' },
            { code: 'ml-IN', name: 'മലയാളം (Malayalam)', flag: '🇮🇳' },
            { code: 'ur-PK', name: 'اردو (Urdu)', flag: '🇵🇰' },
            { code: 'fa-IR', name: 'فارسی (Persian)', flag: '🇮🇷' },
            
            // Other Important Languages
            { code: 'tr-TR', name: 'Türkçe (Turkish)', flag: '🇹🇷' },
            { code: 'iw-IL', name: 'עברית (Hebrew)', flag: '🇮🇱' },
            { code: 'uk-UA', name: 'Українська (Ukrainian)', flag: '🇺🇦' },
            { code: 'el-GR', name: 'Ελληνικά (Greek)', flag: '🇬🇷' },
            { code: 'sr-RS', name: 'Српски (Serbian)', flag: '🇷🇸' },
            { code: 'sw-KE', name: 'Kiswahili (Swahili)', flag: '🇰🇪' },
            { code: 'af-ZA', name: 'Afrikaans', flag: '🇿🇦' },
            { code: 'zu-ZA', name: 'isiZulu (Zulu)', flag: '🇿🇦' },
            { code: 'xh-ZA', name: 'isiXhosa (Xhosa)', flag: '🇿🇦' },
            { code: 'is-IS', name: 'Íslenska (Icelandic)', flag: '🇮🇸' },
            { code: 'ca-ES', name: 'Català (Catalan)', flag: '🇪🇸' }
        ];
        
        this.initializeElements();
        this.initializeLanguageSelector();
        this.checkBrowserSupport();
    }
    
    initializeElements() {
        // Buttons
        this.startBtn = document.getElementById('startRecording');
        this.pauseBtn = document.getElementById('pauseRecording');
        this.stopBtn = document.getElementById('stopRecording');
        this.playBtn = document.getElementById('playButton');
        this.saveBtn = document.getElementById('saveRecording');
        this.transcriptionBtn = document.getElementById('startTranscription');
        this.discardBtn = document.getElementById('discardRecording');
        this.recordAgainBtn = document.getElementById('recordAgain');
        this.requestPermissionBtn = document.getElementById('requestPermission');
        
        // Status elements
        this.micStatus = document.getElementById('micStatus');
        this.micStatusText = document.getElementById('micStatusText');
        this.recordingStatus = document.getElementById('recordingStatus');
        this.pausedStatus = document.getElementById('pausedStatus');
        this.recordingControls = document.getElementById('recordingControls');
        this.playbackSection = document.getElementById('playbackSection');
        this.audioVisualizer = document.getElementById('audioVisualizer');
        
        // Time elements
        this.recordingTime = document.getElementById('recordingTime');
        this.pausedTime = document.getElementById('pausedTime');
        this.currentTime = document.getElementById('currentTime');
        this.totalTime = document.getElementById('totalTime');
        this.progressBar = document.getElementById('progressBar');
        
        // Language select
        this.languageSelect = document.getElementById('languageSelect');
        
        // Recording mode elements
        this.microphoneMode = document.getElementById('microphoneMode');
        this.uploadMode = document.getElementById('uploadMode');
        this.microphoneSection = document.getElementById('microphoneSection');
        this.fileUploadSection = document.getElementById('fileUploadSection');
        
        // File upload elements
        this.uploadArea = document.getElementById('uploadArea');
        this.uploadContent = document.getElementById('uploadContent');
        this.fileInfo = document.getElementById('fileInfo');
        this.uploadProgress = document.getElementById('uploadProgress');
        this.audioFileInput = document.getElementById('audioFileInput');
        this.browseFileBtn = document.getElementById('browseFileBtn');
        this.processFileBtn = document.getElementById('processFileBtn');
        this.removeFileBtn = document.getElementById('removeFileBtn');
        this.audioPreview = document.getElementById('audioPreview');
        this.fileName = document.getElementById('fileName');
        this.fileSize = document.getElementById('fileSize');
        this.fileFormat = document.getElementById('fileFormat');
        this.fileDuration = document.getElementById('fileDuration');
        this.uploadProgressBar = document.getElementById('uploadProgressBar');
        

        
        this.bindEvents();
    }
    
    bindEvents() {
        this.startBtn.addEventListener('click', () => this.startRecording());
        this.pauseBtn.addEventListener('click', () => this.pauseRecording());
        this.stopBtn.addEventListener('click', () => this.stopRecording());
        this.playBtn.addEventListener('click', () => this.togglePlayback());
        this.saveBtn.addEventListener('click', () => this.saveRecording());
        this.transcriptionBtn.addEventListener('click', () => this.startTranscription());
        this.discardBtn.addEventListener('click', () => this.discardRecording());
        this.recordAgainBtn.addEventListener('click', () => this.recordAgain());
        this.requestPermissionBtn.addEventListener('click', () => this.requestMicrophonePermission());
        
        // Recording mode events
        this.microphoneMode.addEventListener('change', () => this.switchToMicrophoneMode());
        this.uploadMode.addEventListener('change', () => this.switchToUploadMode());
        
        // File upload events
        this.uploadArea.addEventListener('click', (e) => {
            // Only trigger if clicking the upload area itself, not nested elements
            if (e.target === this.uploadArea || e.target.closest('#uploadContent')) {
                this.audioFileInput.click();
            }
        });
        this.browseFileBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent event bubbling to uploadArea
            this.audioFileInput.click();
        });
        this.audioFileInput.addEventListener('change', (e) => this.handleFileSelect(e));
        this.processFileBtn.addEventListener('click', () => this.processUploadedFile());
        this.removeFileBtn.addEventListener('click', () => this.removeUploadedFile());
        
        // Drag and drop events
        this.uploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
        this.uploadArea.addEventListener('dragleave', (e) => this.handleDragLeave(e));
        this.uploadArea.addEventListener('drop', (e) => this.handleFileDrop(e));
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !e.target.matches('input, textarea, select')) {
                e.preventDefault();
                if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
                    this.pauseRecording();
                } else if (this.mediaRecorder && this.mediaRecorder.state === 'paused') {
                    this.resumeRecording();
                } else {
                    this.startRecording();
                }
            }
        });
        

        
        // Chat events
        this.sendChatBtn = document.getElementById('sendChatMessage');
        this.chatInput = document.getElementById('chatInput');
        this.chatHistory = document.getElementById('chatHistory');
        this.chatPlaceholder = document.getElementById('chatPlaceholder');
        this.chatLoading = document.getElementById('chatLoading');
        
        this.sendChatBtn.addEventListener('click', () => this.sendChatMessage());
        this.chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendChatMessage();
            }
        });
        
        // Chat system variables
        this.chatMessages = [];
        this.currentStoryText = '';
        this.selectedLanguageCode = 'en-US';
        
        // Initialize language selector
        this.initializeLanguageSelector();
    }
    
    initializeLanguageSelector() {
        console.log('Initializing language selector...');
        
        this.selectedLanguageElement = document.getElementById('selectedLanguage');
        this.languageDropdown = document.getElementById('languageDropdown');
        this.languageSearch = document.getElementById('languageSearch');
        this.allLanguagesContainer = document.getElementById('allLanguages');
        this.recentLanguagesContainer = document.getElementById('recentLanguages');
        this.languageSelectInput = document.getElementById('languageSelect');
        
        console.log('Elements found:', {
            selectedLanguageElement: !!this.selectedLanguageElement,
            languageDropdown: !!this.languageDropdown,
            languageSearch: !!this.languageSearch,
            allLanguagesContainer: !!this.allLanguagesContainer,
            recentLanguagesContainer: !!this.recentLanguagesContainer,
            languageSelectInput: !!this.languageSelectInput
        });
        
        // Populate all languages
        this.populateAllLanguages();
        
        // Show recent languages if any
        this.updateRecentLanguages();
        
        // Bind language selector events
        this.bindLanguageSelectorEvents();
        
        // Backup event binding in case elements aren't ready
        setTimeout(() => {
            this.bindBackupEvents();
        }, 100);
        
        console.log('Language selector initialized');
    }
    
    bindLanguageSelectorEvents() {
        // Toggle dropdown
        this.selectedLanguageElement.addEventListener('click', (e) => {
            console.log('Language selector clicked');
            e.stopPropagation();
            this.toggleLanguageDropdown();
        });
        
        // Search functionality
        this.languageSearch.addEventListener('input', (e) => {
            this.filterLanguages(e.target.value);
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.language-selector-container')) {
                this.closeLanguageDropdown();
            }
        });
        
        // Keyboard navigation
        this.languageSearch.addEventListener('keydown', (e) => {
            this.handleKeyboardNavigation(e);
        });
    }
    
    bindBackupEvents() {
        // Backup event binding using document.getElementById
        const selectedLanguageElement = document.getElementById('selectedLanguage');
        if (selectedLanguageElement && !selectedLanguageElement.hasAttribute('data-event-bound')) {
            console.log('Binding backup click event');
            selectedLanguageElement.addEventListener('click', (e) => {
                console.log('Backup language selector clicked');
                e.stopPropagation();
                this.toggleLanguageDropdown();
            });
            selectedLanguageElement.setAttribute('data-event-bound', 'true');
        }
    }
    
    populateAllLanguages() {
        const container = this.allLanguagesContainer;
        container.innerHTML = '<div class="px-3 py-2" style="background: #f8f9fa; font-size: 0.85rem; font-weight: 600; color: var(--warm-secondary);">All Languages (55)</div>';
        
        this.allLanguages.forEach(lang => {
            if (!lang.popular) { // Don't duplicate popular languages
                const languageOption = document.createElement('div');
                languageOption.className = 'language-option p-3 border-bottom';
                languageOption.style.cursor = 'pointer';
                languageOption.dataset.code = lang.code;
                languageOption.dataset.name = lang.name;
                languageOption.dataset.flag = lang.flag;
                languageOption.innerHTML = `<span class="flag me-2">${lang.flag}</span> ${lang.name}`;
                
                languageOption.addEventListener('click', () => {
                    this.selectLanguage(lang.code, lang.name, lang.flag);
                });
                
                container.appendChild(languageOption);
            }
        });
        
        // Add click events for popular languages too
        document.querySelectorAll('#popularLanguages .language-option').forEach(option => {
            option.addEventListener('click', () => {
                const code = option.dataset.code;
                const name = option.dataset.name;
                const flag = option.dataset.flag;
                this.selectLanguage(code, name, flag);
            });
        });
    }
    
    selectLanguage(code, name, flag) {
        this.selectedLanguage = code;
        this.languageSelectInput.value = code;
        
        // Update display
        this.selectedLanguageElement.querySelector('.flag').textContent = flag;
        this.selectedLanguageElement.querySelector('.language-name').textContent = name;
        
        // Add to recent languages
        this.addToRecentLanguages(code, name, flag);
        
        // Close dropdown
        this.closeLanguageDropdown();
        
        // Clear search
        this.languageSearch.value = '';
        this.filterLanguages('');
    }
    
    toggleLanguageDropdown() {
        console.log('Toggle language dropdown called');
        console.log('Dropdown element:', this.languageDropdown);
        console.log('Has d-none class:', this.languageDropdown.classList.contains('d-none'));
        
        if (this.languageDropdown.classList.contains('d-none')) {
            this.openLanguageDropdown();
        } else {
            this.closeLanguageDropdown();
        }
    }
    
    openLanguageDropdown() {
        console.log('Opening language dropdown');
        console.log('Dropdown element before:', this.languageDropdown);
        console.log('Current classes:', this.languageDropdown.className);
        
        this.languageDropdown.classList.remove('d-none');
        this.languageDropdown.style.display = 'block'; // Force display
        this.languageDropdown.style.visibility = 'visible'; // Force visibility
        this.languageDropdown.style.opacity = '1'; // Force opacity
        
        console.log('Classes after removal:', this.languageDropdown.className);
        console.log('Display style:', this.languageDropdown.style.display);
        
        const arrow = this.selectedLanguageElement.querySelector('.dropdown-arrow');
        if (arrow) {
            arrow.style.transform = 'rotate(180deg)';
        }
        
        // Focus search input
        setTimeout(() => {
            if (this.languageSearch) {
                this.languageSearch.focus();
            }
        }, 100);
        
        console.log('Language dropdown opened');
    }
    
    closeLanguageDropdown() {
        console.log('Closing language dropdown');
        this.languageDropdown.classList.add('d-none');
        this.languageDropdown.style.display = 'none'; // Force hide
        
        const arrow = this.selectedLanguageElement.querySelector('.dropdown-arrow');
        if (arrow) {
            arrow.style.transform = 'rotate(0deg)';
        }
        
        console.log('Language dropdown closed');
    }
    
    filterLanguages(searchTerm) {
        const term = searchTerm.toLowerCase();
        const allOptions = document.querySelectorAll('.language-option');
        
        allOptions.forEach(option => {
            const languageName = option.textContent.toLowerCase();
            const languageCode = option.dataset.code.toLowerCase();
            
            if (languageName.includes(term) || languageCode.includes(term)) {
                option.style.display = 'block';
            } else {
                option.style.display = 'none';
            }
        });
        
        // Show/hide sections based on visible options
        this.updateSectionVisibility();
    }
    
    updateSectionVisibility() {
        const popularSection = document.getElementById('popularLanguages');
        const allLanguagesSection = document.getElementById('allLanguages');
        
        const popularVisible = popularSection.querySelectorAll('.language-option[style*="display: block"], .language-option:not([style*="display: none"])').length > 0;
        const allVisible = allLanguagesSection.querySelectorAll('.language-option[style*="display: block"], .language-option:not([style*="display: none"])').length > 0;
        
        popularSection.style.display = popularVisible ? 'block' : 'none';
        allLanguagesSection.style.display = allVisible ? 'block' : 'none';
    }
    
    handleKeyboardNavigation(e) {
        // Implementation for arrow keys navigation would go here
        // For now, just handle Enter to select first visible option
        if (e.key === 'Enter') {
            const firstVisible = document.querySelector('.language-option[style*="display: block"], .language-option:not([style*="display: none"])');
            if (firstVisible) {
                firstVisible.click();
            }
        }
    }
    
    getRecentLanguages() {
        const recent = localStorage.getItem('voicerecorder_recent_languages');
        return recent ? JSON.parse(recent) : [];
    }
    
    addToRecentLanguages(code, name, flag) {
        let recent = this.getRecentLanguages();
        
        // Remove if already exists
        recent = recent.filter(lang => lang.code !== code);
        
        // Add to beginning
        recent.unshift({ code, name, flag, timestamp: Date.now() });
        
        // Keep only last 5
        recent = recent.slice(0, 5);
        
        // Save to localStorage
        localStorage.setItem('voicerecorder_recent_languages', JSON.stringify(recent));
        this.recentLanguages = recent;
        
        // Update display
        this.updateRecentLanguages();
    }
    
    updateRecentLanguages() {
        const container = this.recentLanguagesContainer;
        const listContainer = document.getElementById('recentLanguagesList');
        
        if (this.recentLanguages.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'block';
        listContainer.innerHTML = '';
        
        this.recentLanguages.forEach(lang => {
            const option = document.createElement('div');
            option.className = 'language-option p-3 border-bottom';
            option.style.cursor = 'pointer';
            option.dataset.code = lang.code;
            option.dataset.name = lang.name;
            option.dataset.flag = lang.flag;
            option.innerHTML = `<span class="flag me-2">${lang.flag}</span> ${lang.name}`;
            
            option.addEventListener('click', () => {
                this.selectLanguage(lang.code, lang.name, lang.flag);
            });
            
            listContainer.appendChild(option);
        });
    }
    
    // Recording Mode Methods
    switchToMicrophoneMode() {
        this.recordingMode = 'microphone';
        this.microphoneSection.classList.remove('d-none');
        this.fileUploadSection.classList.add('d-none');
        this.hideTranscriptionSection();
    }
    
    switchToUploadMode() {
        this.recordingMode = 'upload';
        this.microphoneSection.classList.add('d-none');
        this.fileUploadSection.classList.remove('d-none');
        this.hideTranscriptionSection();
    }
    
    // File Upload Methods
    handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        this.uploadArea.style.borderColor = 'var(--warm-primary)';
        this.uploadArea.style.backgroundColor = '#FFF8E1';
    }
    
    handleDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        this.uploadArea.style.borderColor = 'var(--warm-neutral)';
        this.uploadArea.style.backgroundColor = '';
    }
    
    handleFileDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        this.handleDragLeave(e);
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            this.processFile(files[0]);
        }
    }
    
    handleFileSelect(e) {
        const files = e.target.files;
        if (files.length > 0) {
            this.processFile(files[0]);
        }
    }
    
    processFile(file) {
        // Validate file
        const validation = this.validateFile(file);
        if (!validation.valid) {
            this.showError(validation.error);
            return;
        }
        
        this.uploadedFile = file;
        this.showFileInfo(file);
        this.createAudioPreview(file);
    }
    
    validateFile(file) {
        // Check file size
        if (file.size > this.maxFileSize) {
            return {
                valid: false,
                error: `File size too large. Maximum allowed: ${this.formatFileSize(this.maxFileSize)}`
            };
        }
        
        // Check file format
        const fileName = file.name.toLowerCase();
        const fileExtension = fileName.split('.').pop();
        
        if (!this.supportedFormats.includes(fileExtension)) {
            return {
                valid: false,
                error: `Unsupported format. Supported formats: ${this.supportedFormats.join(', ').toUpperCase()}`
            };
        }
        
        return { valid: true };
    }
    
    showFileInfo(file) {
        this.uploadContent.classList.add('d-none');
        this.fileInfo.classList.remove('d-none');
        
        this.fileName.textContent = file.name;
        this.fileSize.textContent = this.formatFileSize(file.size);
        this.fileFormat.textContent = file.type || 'Unknown';
        this.fileDuration.textContent = 'Calculating...';
    }
    
    createAudioPreview(file) {
        const url = URL.createObjectURL(file);
        this.audioPreview.src = url;
        
        // Get duration when metadata loads
        this.audioPreview.addEventListener('loadedmetadata', () => {
            const duration = this.audioPreview.duration;
            this.fileDuration.textContent = this.formatTime(duration);
            
            // Check duration limit (60 minutes = 3600 seconds)
            if (duration > 3600) {
                this.showError('Audio file too long. Maximum duration: 60 minutes');
                this.removeUploadedFile();
                return;
            }
        });
    }
    
    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    removeUploadedFile() {
        this.uploadedFile = null;
        this.uploadContent.classList.remove('d-none');
        this.fileInfo.classList.add('d-none');
        this.audioFileInput.value = '';
        
        if (this.audioPreview.src) {
            URL.revokeObjectURL(this.audioPreview.src);
            this.audioPreview.src = '';
        }
        
        this.hideTranscriptionSection();
    }
    
    async processUploadedFile() {
        if (!this.uploadedFile) {
            this.showError('No file selected');
            return;
        }
        
        // Hide playback section for file uploads (only show for recordings)
        this.playbackSection.classList.add('d-none');
        
        // Show transcription section and start processing
        this.showTranscriptionSection();
        await this.transcribeUploadedFile();
    }
    
    async transcribeUploadedFile() {
        try {
            console.log('🎯 === 开始转录上传文件 START TRANSCRIPTION ===');
            
            if (!this.uploadedFile) {
                throw new Error('No audio file found');
            }
            
            console.log('📁 文件信息 FILE INFO:', {
                name: this.uploadedFile.name,
                size: this.uploadedFile.size,
                type: this.uploadedFile.type
            });
            
            // Get audio duration
            const duration = this.audioPreview.duration;
            const selectedLanguage = this.selectedLanguage;
            
            console.log('⏱️ 音频时长 DURATION:', duration, 'seconds');
            console.log('🌍 选择语言 LANGUAGE:', selectedLanguage);
            
            // Choose processing strategy based on duration
            console.log(`🤔 选择处理策略 CHOOSING STRATEGY: ${duration}s audio`);
            
            if (duration < 60) {
                // Short file: Direct Google API call (< 1 minute limit)
                console.log('✅ 使用直接处理 DIRECT PROCESSING (< 60s)');
                await this.transcribeShortFile(this.uploadedFile, selectedLanguage);
            } else {
                // Long file: MUST use chunking (≥ 60 seconds)
                console.log(`✂️ 使用分块处理 CHUNKING APPROACH for ${duration}s audio`);
                await this.transcribeWithChunking(this.uploadedFile, selectedLanguage, duration);
            }
            
        } catch (error) {
            document.getElementById('transcriptionLoading').classList.add('d-none');
            this.showTranscriptionError(error.message);
        }
    }
    
    async transcribeShortFile(file, language) {
        try {
            console.log('📤 === 直接处理短文件 DIRECT SHORT FILE PROCESSING ===');
            console.log('📁 发送文件 SENDING FILE:', {
                name: file.name,
                size: file.size,
                type: file.type
            });
            console.log('🌍 语言 LANGUAGE:', language);
            
            const formData = new FormData();
            formData.append('audio', file, file.name);
            formData.append('language', language);
            formData.append('mode', 'sync');
            
            console.log('🚀 发送API请求 SENDING API REQUEST...');
            
            const response = await fetch('/api/transcribe', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            });
            
            console.log('📨 API响应状态 RESPONSE STATUS:', response.status);
            
            const result = await response.json();
            
            console.log('📋 API响应结果 RESPONSE RESULT:', result);
            
            document.getElementById('transcriptionLoading').classList.add('d-none');
            
            if (result.success) {
                console.log('✅ 转录成功 TRANSCRIPTION SUCCESS');
                this.showTranscriptionResult(result);
            } else {
                console.log('❌ 转录失败 TRANSCRIPTION FAILED:', result.error);
                this.showTranscriptionError(result.error);
            }
            
        } catch (error) {
            console.log('💥 直接处理异常 DIRECT PROCESSING ERROR:', error);
            document.getElementById('transcriptionLoading').classList.add('d-none');
            this.showTranscriptionError(error.message);
        }
    }
    
    async transcribeWithChunking(file, language, totalDuration) {
        try {
            console.log('✂️ === 开始分块处理 START CHUNKING PROCESS ===');
            console.log('📁 原始文件 ORIGINAL FILE:', {
                name: file.name,
                size: file.size,
                type: file.type,
                duration: totalDuration
            });
            
            // Update loading message
            document.getElementById('transcriptionLoading').classList.remove('d-none');
            const loadingText = document.querySelector('#transcriptionLoading p');
            const numChunks = Math.ceil(totalDuration / 59);
            const avgChunkDuration = totalDuration / numChunks;
            
            console.log('🔢 分块计算 CHUNK CALCULATION:', {
                totalDuration,
                numChunks,
                avgChunkDuration
            });
            
            loadingText.innerHTML = `
                <i class="fas fa-magic me-2"></i>
                分割音频：${totalDuration.toFixed(1)}秒 → ${numChunks}个片段 (每个~${avgChunkDuration.toFixed(1)}秒)<br>
                Splitting audio: ${totalDuration.toFixed(1)}s → ${numChunks} chunks (~${avgChunkDuration.toFixed(1)}s each)
            `;
            
            console.log('🔨 创建音频分块 CREATING AUDIO CHUNKS...');
            // Create audio chunks
            const chunks = await this.createAudioChunks(file, totalDuration);
            
            console.log('📊 分块创建完成 CHUNKS CREATED:', {
                totalChunks: chunks.length,
                chunks: chunks.map(chunk => ({
                    index: chunk.index,
                    duration: chunk.duration,
                    size: chunk.blob.size,
                    startTime: chunk.startTime,
                    endTime: chunk.endTime
                }))
            });
            
            console.log('🚀 开始批量处理分块 START BATCH PROCESSING...');
            // Process chunks in parallel (but limit concurrency)
            const results = await this.processChunksInBatches(chunks, language);
            
            console.log('📋 分块处理结果 CHUNK PROCESSING RESULTS:', results);
            
            // Combine results
            const combinedTranscript = this.combineTranscripts(results);
            const averageConfidence = this.calculateAverageConfidence(results);
            
            console.log('🔗 合并结果 COMBINED RESULTS:', {
                transcript: combinedTranscript.substring(0, 100) + '...',
                confidence: averageConfidence,
                chunkCount: chunks.length
            });
            
            // Apply Gemini polishing to the combined transcript
            console.log('✨ 开始Gemini润色 START GEMINI POLISHING...');
            try {
                const polishingResponse = await fetch('/api/test-gemini', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: combinedTranscript,
                        language: language
                    })
                });
                
                const polishingResult = await polishingResponse.json();
                console.log('✨ Gemini润色结果 GEMINI POLISHING RESULT:', polishingResult);
                
                document.getElementById('transcriptionLoading').classList.add('d-none');
                
                if (polishingResult.success && polishingResult.gemini?.success) {
                    // Both raw transcript and polished version available
                    this.showTranscriptionResult({
                        success: true,
                        transcript: polishingResult.gemini.content,  // Polished version
                        raw_transcript: combinedTranscript,  // Raw Google output
                        confidence: averageConfidence,
                        chunked: true,
                        chunkCount: chunks.length,
                        polished: true,
                        gemini: polishingResult.gemini
                    });
                } else {
                    // Fallback: show raw transcript only
                    console.log('⚠️ Gemini润色失败，显示原始转录 GEMINI POLISHING FAILED, SHOWING RAW');
                    this.showTranscriptionResult({
                        success: true,
                        transcript: combinedTranscript,  // Raw transcript as main
                        raw_transcript: combinedTranscript,  // Same as raw
                        confidence: averageConfidence,
                        chunked: true,
                        chunkCount: chunks.length,
                        polished: false,
                        gemini: polishingResult.gemini || { success: false, error: 'Polishing failed' }
                    });
                }
                
            } catch (error) {
                console.log('💥 Gemini润色异常 GEMINI POLISHING ERROR:', error);
                document.getElementById('transcriptionLoading').classList.add('d-none');
                
                // Fallback: show raw transcript only
                this.showTranscriptionResult({
                    success: true,
                    transcript: combinedTranscript,  // Raw transcript as main
                    raw_transcript: combinedTranscript,  // Same as raw
                    confidence: averageConfidence,
                    chunked: true,
                    chunkCount: chunks.length,
                    polished: false,
                    gemini: { success: false, error: `Polishing error: ${error.message}` }
                });
            }
            
        } catch (error) {
            console.error('Chunking failed:', error);
            
            // Fallback: try original upload method if chunking fails
            loadingText.innerHTML = `
                <i class="fas fa-magic me-2"></i>
                Chunking failed, trying alternative method...
            `;
            
            try {
                await this.fallbackToOriginalUpload(file, language);
            } catch (fallbackError) {
                document.getElementById('transcriptionLoading').classList.add('d-none');
                this.showTranscriptionError(`Both chunking and fallback failed. Original error: ${error.message}`);
            }
        }
    }
    
    async fallbackToOriginalUpload(file, language) {
        // Try the original simple upload method as fallback
        const formData = new FormData();
        formData.append('audio', file, file.name);
        formData.append('language', language);
        formData.append('mode', 'upload'); // Use original mode
        
        const response = await fetch('/api/transcribe', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        document.getElementById('transcriptionLoading').classList.add('d-none');
        
        if (result.success) {
            // Add a note that fallback was used
            result.fallback = true;
            this.showTranscriptionResult(result);
        } else {
            throw new Error(result.error || 'Transcription failed');
        }
    }
    
    async transcribeLongFile(file, language) {
        try {
            // Update loading message
            const loadingText = document.querySelector('#transcriptionLoading p');
            loadingText.innerHTML = `
                <i class="fas fa-magic me-2"></i>
                Processing long file (this may take a few minutes)...
            `;
            
            const formData = new FormData();
            formData.append('audio', file, file.name);
            formData.append('language', language);
            formData.append('mode', 'async');
            
            const response = await fetch('/api/transcribe', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            });
            
            const result = await response.json();
            
            document.getElementById('transcriptionLoading').classList.add('d-none');
            
            if (result.success) {
                this.showTranscriptionResult(result);
            } else {
                this.showTranscriptionError(result.error);
            }
            
        } catch (error) {
            document.getElementById('transcriptionLoading').classList.add('d-none');
            this.showTranscriptionError(error.message);
        }
    }
    
    async createAudioChunks(file, totalDuration) {
        return new Promise((resolve, reject) => {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                try {
                    const arrayBuffer = e.target.result;
                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    
                    // Smart chunking: calculate optimal chunk sizes
                    const chunks = [];
                    const sampleRate = audioBuffer.sampleRate;
                    const maxChunkDuration = 59; // Google API limit
                    
                    // Calculate number of chunks needed
                    const numChunks = Math.ceil(totalDuration / maxChunkDuration);
                    const idealChunkDuration = totalDuration / numChunks;
                    
                    console.log(`🔧 音频分割计划 AUDIO SPLITTING PLAN: ${totalDuration}s → ${numChunks} chunks (~${idealChunkDuration.toFixed(1)}s each)`);
                    
                    for (let i = 0; i < numChunks; i++) {
                        const startTime = i * idealChunkDuration;
                        const endTime = Math.min((i + 1) * idealChunkDuration, totalDuration);
                        const actualDuration = endTime - startTime;
                        
                        console.log(`🎵 创建分块 ${i + 1} CREATING CHUNK ${i + 1}: ${startTime.toFixed(1)}s - ${endTime.toFixed(1)}s (${actualDuration.toFixed(1)}s)`);
                        
                        // 验证分块时长
                        if (actualDuration >= 60) {
                            console.log('🚨 错误 ERROR: 分块时长超过60秒！CHUNK DURATION EXCEEDS 60s!', actualDuration);
                        }
                        
                        const startSample = Math.floor(startTime * sampleRate);
                        const endSample = Math.floor(endTime * sampleRate);
                        
                        console.log(`📊 采样信息 SAMPLE INFO: ${startSample} - ${endSample} (total: ${endSample - startSample} samples)`);
                        
                        const chunkBuffer = audioContext.createBuffer(
                            audioBuffer.numberOfChannels,
                            endSample - startSample,
                            sampleRate
                        );
                        
                        // Copy audio data
                        for (let channel = 0; channel < audioBuffer.numberOfChannels; channel++) {
                            const channelData = audioBuffer.getChannelData(channel);
                            const chunkData = chunkBuffer.getChannelData(channel);
                            for (let j = 0; j < endSample - startSample; j++) {
                                chunkData[j] = channelData[startSample + j];
                            }
                        }
                        
                        // Convert to WAV blob
                        const wavBlob = this.audioBufferToWav(chunkBuffer);
                        
                        console.log(`💾 WAV分块大小 WAV CHUNK SIZE: ${wavBlob.size} bytes`);
                        
                        chunks.push({
                            blob: wavBlob,
                            index: i,
                            startTime: startTime,
                            endTime: endTime,
                            duration: actualDuration
                        });
                        
                        console.log(`✅ 分块 ${i + 1} 创建完成 CHUNK ${i + 1} CREATED: ${actualDuration.toFixed(1)}s, ${wavBlob.size} bytes`);
                    }
                    
                    resolve(chunks);
                } catch (error) {
                    reject(error);
                }
            };
            
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }
    
    async processChunksInBatches(chunks, language, batchSize = 3) {
        const results = [];
        
        for (let i = 0; i < chunks.length; i += batchSize) {
            const batch = chunks.slice(i, i + batchSize);
            const batchPromises = batch.map(chunk => this.transcribeChunk(chunk, language));
            
            // Update progress
            const loadingText = document.querySelector('#transcriptionLoading p');
            loadingText.innerHTML = `
                <i class="fas fa-magic me-2"></i>
                Processing chunk ${i + 1}-${Math.min(i + batchSize, chunks.length)} of ${chunks.length}...
            `;
            
            const batchResults = await Promise.allSettled(batchPromises);
            results.push(...batchResults);
            
            // Small delay between batches to avoid rate limiting
            if (i + batchSize < chunks.length) {
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }
        
        return results;
    }
    
    async transcribeChunk(chunk, language) {
        console.log(`📤 === 处理分块 ${chunk.index + 1} PROCESSING CHUNK ${chunk.index + 1} ===`);
        console.log('📁 分块信息 CHUNK INFO:', {
            index: chunk.index,
            duration: chunk.duration,
            size: chunk.blob.size,
            startTime: chunk.startTime,
            endTime: chunk.endTime,
            fileName: `chunk_${chunk.index}.wav`
        });
        
        if (chunk.duration >= 60) {
            console.log('⚠️ 警告 WARNING: 分块时长超过60秒！', chunk.duration);
        }
        
        const formData = new FormData();
        formData.append('audio', chunk.blob, `chunk_${chunk.index}.wav`);
        formData.append('language', language);
        formData.append('mode', 'sync');
        formData.append('chunkIndex', chunk.index);
        formData.append('startTime', chunk.startTime);
        
        console.log('🚀 发送分块API请求 SENDING CHUNK API REQUEST...');
        
        const response = await fetch('/api/transcribe', {
            method: 'POST',
            body: formData
        });
        
        console.log(`📨 分块 ${chunk.index + 1} API响应状态 CHUNK ${chunk.index + 1} RESPONSE STATUS:`, response.status);
        
        const result = await response.json();
        
        console.log(`📋 分块 ${chunk.index + 1} API响应结果 CHUNK ${chunk.index + 1} RESPONSE:`, result);
        
        return result;
    }
    
    combineTranscripts(results) {
        const successfulResults = results
            .filter(result => result.status === 'fulfilled' && result.value.success)
            .map(result => result.value)
            .sort((a, b) => (a.chunkIndex || 0) - (b.chunkIndex || 0));
        
        return successfulResults
            .map(result => result.transcript)
            .join(' ')
            .replace(/\s+/g, ' ')
            .trim();
    }
    
    calculateAverageConfidence(results) {
        const successfulResults = results
            .filter(result => result.status === 'fulfilled' && result.value.success)
            .map(result => result.value);
        
        if (successfulResults.length === 0) return 0;
        
        const totalConfidence = successfulResults.reduce((sum, result) => {
            return sum + (result.confidence || 0);
        }, 0);
        
        return totalConfidence / successfulResults.length;
    }
    
    audioBufferToWav(buffer) {
        console.log('🎵 转换音频缓冲为WAV CONVERTING AUDIO BUFFER TO WAV:', {
            length: buffer.length,
            sampleRate: buffer.sampleRate,
            numberOfChannels: buffer.numberOfChannels,
            duration: buffer.duration
        });
        
        const length = buffer.length;
        const numberOfChannels = buffer.numberOfChannels;
        const sampleRate = buffer.sampleRate;
        const bytesPerSample = 2; // 16-bit
        const blockAlign = numberOfChannels * bytesPerSample;
        const byteRate = sampleRate * blockAlign;
        const dataSize = length * blockAlign;
        const arrayBuffer = new ArrayBuffer(44 + dataSize);
        const view = new DataView(arrayBuffer);
        
        // WAV header
        const writeString = (offset, string) => {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        };
        
        // RIFF chunk descriptor
        writeString(0, 'RIFF');                           // ChunkID
        view.setUint32(4, 36 + dataSize, true);           // ChunkSize
        writeString(8, 'WAVE');                           // Format
        
        // fmt sub-chunk
        writeString(12, 'fmt ');                          // Subchunk1ID
        view.setUint32(16, 16, true);                     // Subchunk1Size (16 for PCM)
        view.setUint16(20, 1, true);                      // AudioFormat (1 for PCM)
        view.setUint16(22, numberOfChannels, true);       // NumChannels
        view.setUint32(24, sampleRate, true);             // SampleRate
        view.setUint32(28, byteRate, true);               // ByteRate
        view.setUint16(32, blockAlign, true);             // BlockAlign
        view.setUint16(34, 16, true);                     // BitsPerSample
        
        // data sub-chunk
        writeString(36, 'data');                          // Subchunk2ID
        view.setUint32(40, dataSize, true);               // Subchunk2Size
        
        console.log('📊 WAV文件头信息 WAV HEADER INFO:', {
            channels: numberOfChannels,
            sampleRate: sampleRate,
            byteRate: byteRate,
            blockAlign: blockAlign,
            dataSize: dataSize,
            totalSize: 44 + dataSize
        });
        
        // Convert float samples to 16-bit PCM
        let offset = 44;
        for (let i = 0; i < length; i++) {
            for (let channel = 0; channel < numberOfChannels; channel++) {
                const channelData = buffer.getChannelData(channel);
                const sample = Math.max(-1, Math.min(1, channelData[i]));
                view.setInt16(offset, sample * 0x7FFF, true);
                offset += 2;
            }
        }
        
        console.log('✅ WAV转换完成 WAV CONVERSION COMPLETE:', {
            finalSize: arrayBuffer.byteLength,
            expectedSize: 44 + dataSize
        });
        
        return new Blob([arrayBuffer], { type: 'audio/wav' });
    }
    
    hideTranscriptionSection() {
        document.getElementById('transcriptionSection').classList.add('d-none');
    }
    
    checkBrowserSupport() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            this.showError('Your browser does not support audio recording. Please use Chrome, Edge, Firefox, or Safari.');
            return false;
        }
        
        if (!window.MediaRecorder) {
            this.showError('MediaRecorder is not supported in your browser. Please update to the latest version.');
            return false;
        }
        
        return true;
    }
    
    async requestMicrophonePermission() {
        try {
            this.showStatus('Requesting microphone permission...', 'info');
            
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                } 
            });
            
            this.setupAudioContext(stream);
            this.showStatus('Microphone ready! Click the record button to start.', 'success');
            this.startBtn.disabled = false;
            
            // Hide permission modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('permissionModal'));
            if (modal) modal.hide();
            
        } catch (error) {
            console.error('Microphone permission error:', error);
            let errorMessage = 'Could not access microphone. ';
            
            if (error.name === 'NotAllowedError') {
                errorMessage += 'Please allow microphone access and try again.';
            } else if (error.name === 'NotFoundError') {
                errorMessage += 'No microphone found. Please connect a microphone.';
            } else {
                errorMessage += 'Please check your microphone settings.';
            }
            
            this.showError(errorMessage);
        }
    }
    
    setupAudioContext(stream) {
        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        this.analyser = this.audioContext.createAnalyser();
        this.microphone = this.audioContext.createMediaStreamSource(stream);
        
        this.analyser.fftSize = 512;
        this.microphone.connect(this.analyser);
        
        // Store stream for MediaRecorder
        this.stream = stream;
    }
    
    async startRecording() {
        try {
            if (!this.stream) {
                // Show permission modal
                const modal = new bootstrap.Modal(document.getElementById('permissionModal'));
                modal.show();
                return;
            }
            
            this.audioChunks = [];
            this.recordedBlob = null;
            this.startTime = Date.now();
            this.pausedDuration = 0;
            this.isPaused = false;
            
            // Create MediaRecorder
            const options = { mimeType: 'audio/webm' };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                options.mimeType = 'audio/mp4';
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = '';
                }
            }
            
            this.mediaRecorder = new MediaRecorder(this.stream, options);
            
            this.mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    this.audioChunks.push(event.data);
                }
            };
            
            this.mediaRecorder.onstop = () => {
                const mimeType = this.mediaRecorder.mimeType || 'audio/webm';
                this.recordedBlob = new Blob(this.audioChunks, { type: mimeType });
                this.showPlaybackSection();
            };
            
            this.mediaRecorder.start(100); // Collect data every 100ms
            
            this.showRecordingUI();
            this.startTimer();
            this.startVisualization();
            
            this.showStatus('Recording started', 'success');
            
        } catch (error) {
            console.error('Recording start error:', error);
            this.showError('Failed to start recording: ' + error.message);
        }
    }
    
    pauseRecording() {
        if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
            this.mediaRecorder.pause();
            this.isPaused = true;
            this.pauseStartTime = Date.now();
            
            this.recordingStatus.classList.add('d-none');
            this.pausedStatus.classList.remove('d-none');
            
            this.pauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            this.pauseBtn.onclick = () => this.resumeRecording();
            
            this.stopVisualization();
        }
    }
    
    resumeRecording() {
        if (this.mediaRecorder && this.mediaRecorder.state === 'paused') {
            this.mediaRecorder.resume();
            this.isPaused = false;
            this.pausedDuration += Date.now() - this.pauseStartTime;
            
            this.recordingStatus.classList.remove('d-none');
            this.pausedStatus.classList.add('d-none');
            
            this.pauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            this.pauseBtn.onclick = () => this.pauseRecording();
            
            this.startVisualization();
        }
    }
    
    stopRecording() {
        if (this.mediaRecorder && (this.mediaRecorder.state === 'recording' || this.mediaRecorder.state === 'paused')) {
            this.mediaRecorder.stop();
            this.stopTimer();
            this.stopVisualization();
            this.hideRecordingUI();
        }
    }
    
    showRecordingUI() {
        this.startBtn.classList.add('d-none');
        this.recordingControls.classList.remove('d-none');
        this.recordingStatus.classList.remove('d-none');
        this.audioVisualizer.style.display = 'block';
        this.playbackSection.classList.add('d-none');
    }
    
    hideRecordingUI() {
        this.recordingControls.classList.add('d-none');
        this.recordingStatus.classList.add('d-none');
        this.pausedStatus.classList.add('d-none');
        this.audioVisualizer.style.display = 'none';
    }
    
    showPlaybackSection() {
        this.startBtn.classList.remove('d-none');
        this.playbackSection.classList.remove('d-none');
        
        // Create audio element for playback
        this.audioElement = new Audio();
        this.audioElement.src = URL.createObjectURL(this.recordedBlob);
        
        this.audioElement.addEventListener('loadedmetadata', () => {
            this.totalTime.textContent = this.formatTime(this.audioElement.duration);
        });
        
        this.audioElement.addEventListener('timeupdate', () => {
            const progress = (this.audioElement.currentTime / this.audioElement.duration) * 100;
            this.progressBar.style.width = progress + '%';
            this.currentTime.textContent = this.formatTime(this.audioElement.currentTime);
        });
        
        this.audioElement.addEventListener('ended', () => {
            this.playBtn.innerHTML = '<i class="fas fa-play"></i>';
        });
    }
    
    togglePlayback() {
        if (this.audioElement.paused) {
            this.audioElement.play();
            this.playBtn.innerHTML = '<i class="fas fa-pause"></i>';
        } else {
            this.audioElement.pause();
            this.playBtn.innerHTML = '<i class="fas fa-play"></i>';
        }
    }
    
    showTranscriptionSection() {
        document.getElementById('transcriptionSection').classList.remove('d-none');
        document.getElementById('transcriptionLoading').classList.remove('d-none');
        document.getElementById('transcriptionResult').classList.add('d-none');
        document.getElementById('transcriptionError').classList.add('d-none');
    }
    
    async transcribeAudio() {
        try {
            console.log('🎯 === 开始转录录音 START RECORDING TRANSCRIPTION ===');
            
            if (!this.recordedBlob) {
                throw new Error('No audio recording found');
            }
            
            console.log('📁 录音信息 RECORDING INFO:', {
                size: this.recordedBlob.size,
                type: this.recordedBlob.type
            });
            
            // Get audio duration - multiple methods for reliability
            let duration = 0;
            
            console.log('🔍 检测录音时长 DETECTING RECORDING DURATION...');
            
            // Method 1: From playback audio element (if exists and valid)
            if (this.audioElement && this.audioElement.duration && 
                isFinite(this.audioElement.duration) && this.audioElement.duration > 0) {
                duration = this.audioElement.duration;
                console.log('📊 方法1 - 从播放元素获取时长 METHOD 1 - From playback element:', duration, 'seconds');
            }
            // Method 2: Calculate from recording time
            else if (this.startTime) {
                duration = (Date.now() - this.startTime - this.pausedDuration) / 1000;
                console.log('📊 方法2 - 从录音时间计算 METHOD 2 - From recording time:', duration, 'seconds');
            }
            // Method 3: Try to get from blob directly
            else {
                console.log('📊 方法3 - 从Blob直接获取 METHOD 3 - Direct from blob...');
                try {
                    const tempAudio = new Audio();
                    tempAudio.src = URL.createObjectURL(this.recordedBlob);
                    await new Promise((resolve, reject) => {
                        tempAudio.addEventListener('loadedmetadata', () => {
                            if (isFinite(tempAudio.duration) && tempAudio.duration > 0) {
                                duration = tempAudio.duration;
                                console.log('📊 方法3成功 METHOD 3 SUCCESS:', duration, 'seconds');
                            }
                            URL.revokeObjectURL(tempAudio.src);
                            resolve();
                        });
                        tempAudio.addEventListener('error', () => {
                            URL.revokeObjectURL(tempAudio.src);
                            resolve(); // Don't reject, continue with other methods
                        });
                        // Timeout after 2 seconds
                        setTimeout(() => {
                            URL.revokeObjectURL(tempAudio.src);
                            resolve();
                        }, 2000);
                    });
                } catch (error) {
                    console.log('📊 方法3失败 METHOD 3 FAILED:', error.message);
                }
            }
            
            // Validate duration
            if (!duration || !isFinite(duration) || duration <= 0) {
                throw new Error(`无法获取有效的录音时长。检测到时长: ${duration} | Cannot get valid recording duration. Detected: ${duration}`);
            }
            
            console.log('⏱️ 最终录音时长 FINAL RECORDING DURATION:', duration, 'seconds');
            
            const selectedLanguage = this.selectedLanguage;
            console.log('🌍 选择语言 LANGUAGE:', selectedLanguage);
            
            // Choose processing strategy based on duration
            console.log(`🤔 选择处理策略 CHOOSING STRATEGY: ${duration}s recording`);
            
            if (duration < 60) {
                // Short recording: Direct Google API call
                console.log('✅ 使用直接处理 DIRECT PROCESSING (< 60s)');
                await this.transcribeRecordingDirect(this.recordedBlob, selectedLanguage);
            } else {
                // Long recording: Use chunking
                console.log(`✂️ 使用分块处理 CHUNKING APPROACH for ${duration}s recording`);
                await this.transcribeRecordingWithChunking(this.recordedBlob, selectedLanguage, duration);
            }
            
        } catch (error) {
            console.log('💥 录音转录异常 RECORDING TRANSCRIPTION ERROR:', error);
            document.getElementById('transcriptionLoading').classList.add('d-none');
            this.showTranscriptionError(error.message);
        }
    }
    
    async transcribeRecordingDirect(blob, language) {
        try {
            console.log('📤 === 直接处理录音 DIRECT RECORDING PROCESSING ===');
            console.log('📁 发送录音 SENDING RECORDING:', {
                size: blob.size,
                type: blob.type
            });
            
            const formData = new FormData();
            formData.append('audio', blob, 'recording.webm');
            formData.append('language', language);
            formData.append('mode', 'sync');
            
            console.log('🚀 发送录音API请求 SENDING RECORDING API REQUEST...');
            
            const response = await fetch('/api/transcribe', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            });
            
            console.log('📨 录音API响应状态 RECORDING RESPONSE STATUS:', response.status);
            
            const result = await response.json();
            
            console.log('📋 录音API响应结果 RECORDING RESPONSE:', result);
            
            document.getElementById('transcriptionLoading').classList.add('d-none');
            
            if (result.success) {
                console.log('✅ 录音转录成功 RECORDING TRANSCRIPTION SUCCESS');
                this.showTranscriptionResult(result);
            } else {
                console.log('❌ 录音转录失败 RECORDING TRANSCRIPTION FAILED:', result.error);
                this.showTranscriptionError(result.error);
            }
            
        } catch (error) {
            console.log('💥 直接录音处理异常 DIRECT RECORDING ERROR:', error);
            document.getElementById('transcriptionLoading').classList.add('d-none');
            this.showTranscriptionError(error.message);
        }
    }
    
    async transcribeRecordingWithChunking(blob, language, duration) {
        try {
            console.log('✂️ === 开始录音分块处理 START RECORDING CHUNKING ===');
            
            // Create a temporary audio element to process the blob
            const tempAudio = new Audio();
            tempAudio.src = URL.createObjectURL(blob);
            
            // Wait for audio to load
            await new Promise((resolve, reject) => {
                tempAudio.addEventListener('loadedmetadata', resolve);
                tempAudio.addEventListener('error', reject);
            });
            
            console.log('📊 录音元数据 RECORDING METADATA:', {
                tempAudioDuration: tempAudio.duration,
                passedDuration: duration,
                tempIsFinite: isFinite(tempAudio.duration),
                tempIsValid: tempAudio.duration > 0
            });
            
            // Use the passed duration if valid, otherwise try temp audio duration
            let actualDuration;
            if (isFinite(duration) && duration > 0) {
                actualDuration = duration;
                console.log('✅ 使用传入时长 USING PASSED DURATION:', actualDuration);
            } else if (isFinite(tempAudio.duration) && tempAudio.duration > 0) {
                actualDuration = tempAudio.duration;
                console.log('✅ 使用临时音频时长 USING TEMP AUDIO DURATION:', actualDuration);
            } else {
                throw new Error(`无法获取有效的录音时长。传入: ${duration}, 临时音频: ${tempAudio.duration} | Cannot get valid duration. Passed: ${duration}, TempAudio: ${tempAudio.duration}`);
            }
            
            // Clean up temporary URL
            URL.revokeObjectURL(tempAudio.src);
            
            // Create chunks from the blob
            const chunks = await this.createAudioChunksFromBlob(blob, actualDuration);
            
            console.log('📊 录音分块创建完成 RECORDING CHUNKS CREATED:', {
                totalChunks: chunks.length,
                chunks: chunks.map(chunk => ({
                    index: chunk.index,
                    duration: chunk.duration,
                    size: chunk.blob.size
                }))
            });
            
            // Process chunks
            const results = await this.processChunksInBatches(chunks, language);
            
            // Combine results
            const combinedTranscript = this.combineTranscripts(results);
            const averageConfidence = this.calculateAverageConfidence(results);
            
            // Apply Gemini polishing to the combined transcript
            console.log('✨ 开始录音Gemini润色 START RECORDING GEMINI POLISHING...');
            try {
                const polishingResponse = await fetch('/api/test-gemini', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: combinedTranscript,
                        language: language
                    })
                });
                
                const polishingResult = await polishingResponse.json();
                console.log('✨ 录音Gemini润色结果 RECORDING GEMINI POLISHING RESULT:', polishingResult);
                
                document.getElementById('transcriptionLoading').classList.add('d-none');
                
                if (polishingResult.success && polishingResult.gemini?.success) {
                    // Both raw transcript and polished version available
                    this.showTranscriptionResult({
                        success: true,
                        transcript: polishingResult.gemini.content,  // Polished version
                        raw_transcript: combinedTranscript,  // Raw Google output
                        confidence: averageConfidence,
                        chunked: true,
                        chunkCount: chunks.length,
                        polished: true,
                        gemini: polishingResult.gemini
                    });
                } else {
                    // Fallback: show raw transcript only
                    console.log('⚠️ 录音Gemini润色失败，显示原始转录 RECORDING GEMINI POLISHING FAILED, SHOWING RAW');
                    this.showTranscriptionResult({
                        success: true,
                        transcript: combinedTranscript,  // Raw transcript as main
                        raw_transcript: combinedTranscript,  // Same as raw
                        confidence: averageConfidence,
                        chunked: true,
                        chunkCount: chunks.length,
                        polished: false,
                        gemini: polishingResult.gemini || { success: false, error: 'Polishing failed' }
                    });
                }
                
            } catch (error) {
                console.log('💥 录音Gemini润色异常 RECORDING GEMINI POLISHING ERROR:', error);
                document.getElementById('transcriptionLoading').classList.add('d-none');
                
                // Fallback: show raw transcript only
                this.showTranscriptionResult({
                    success: true,
                    transcript: combinedTranscript,  // Raw transcript as main
                    raw_transcript: combinedTranscript,  // Same as raw
                    confidence: averageConfidence,
                    chunked: true,
                    chunkCount: chunks.length,
                    polished: false,
                    gemini: { success: false, error: `Polishing error: ${error.message}` }
                });
            }
            
            // URL already cleaned up earlier
            
        } catch (error) {
            console.log('💥 录音分块处理异常 RECORDING CHUNKING ERROR:', error);
            document.getElementById('transcriptionLoading').classList.add('d-none');
            this.showTranscriptionError(error.message);
        }
    }
    
    async createAudioChunksFromBlob(blob, totalDuration) {
        return new Promise((resolve, reject) => {
            console.log('🔨 从录音Blob创建分块 CREATING CHUNKS FROM RECORDING BLOB');
            console.log('📊 输入参数验证 INPUT VALIDATION:', {
                blobSize: blob.size,
                blobType: blob.type,
                totalDuration: totalDuration,
                isFiniteDuration: isFinite(totalDuration),
                durationValid: totalDuration > 0
            });
            
            // Validate inputs
            if (!isFinite(totalDuration) || totalDuration <= 0) {
                reject(new Error(`无效的时长参数: ${totalDuration} | Invalid duration: ${totalDuration}`));
                return;
            }
            
            if (!blob || blob.size === 0) {
                reject(new Error('无效的音频Blob | Invalid audio blob'));
                return;
            }
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                try {
                    const arrayBuffer = e.target.result;
                    console.log('📊 ArrayBuffer大小 ARRAYBUFFER SIZE:', arrayBuffer.byteLength);
                    
                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    console.log('📊 音频缓冲信息 AUDIO BUFFER INFO:', {
                        length: audioBuffer.length,
                        duration: audioBuffer.duration,
                        sampleRate: audioBuffer.sampleRate,
                        numberOfChannels: audioBuffer.numberOfChannels
                    });
                    
                    // Use actual audio buffer duration if available and valid
                    const actualDuration = (audioBuffer.duration && isFinite(audioBuffer.duration) && audioBuffer.duration > 0) 
                        ? audioBuffer.duration 
                        : totalDuration;
                    
                    console.log('⏱️ 使用的实际时长 ACTUAL DURATION USED:', actualDuration);
                    
                    const chunks = [];
                    const sampleRate = audioBuffer.sampleRate;
                    const maxChunkDuration = 59;
                    
                    const numChunks = Math.ceil(actualDuration / maxChunkDuration);
                    const idealChunkDuration = actualDuration / numChunks;
                    
                    console.log(`🔧 录音分割计划 RECORDING SPLITTING PLAN: ${actualDuration}s → ${numChunks} chunks (~${idealChunkDuration.toFixed(1)}s each)`);
                    
                    for (let i = 0; i < numChunks; i++) {
                        const startTime = i * idealChunkDuration;
                        const endTime = Math.min((i + 1) * idealChunkDuration, actualDuration);
                        const chunkDuration = endTime - startTime;
                        
                        console.log(`🎵 创建录音分块 ${i + 1} CREATING RECORDING CHUNK ${i + 1}: ${startTime.toFixed(1)}s - ${endTime.toFixed(1)}s (${chunkDuration.toFixed(1)}s)`);
                        
                        if (chunkDuration >= 60) {
                            console.log('🚨 错误 ERROR: 录音分块时长超过60秒！RECORDING CHUNK EXCEEDS 60s!', chunkDuration);
                        }
                        
                        const startSample = Math.floor(startTime * sampleRate);
                        const endSample = Math.floor(endTime * sampleRate);
                        const sampleCount = endSample - startSample;
                        
                        console.log(`📊 采样信息 SAMPLE INFO: ${startSample} - ${endSample} (count: ${sampleCount})`);
                        
                        // Validate sample count
                        if (sampleCount <= 0 || !isFinite(sampleCount)) {
                            console.log('🚨 错误 ERROR: 无效的采样数量！INVALID SAMPLE COUNT!', sampleCount);
                            throw new Error(`无效的采样数量: ${sampleCount} | Invalid sample count: ${sampleCount}`);
                        }
                        
                        if (endSample > audioBuffer.length) {
                            console.log('🚨 错误 ERROR: 结束采样超出范围！END SAMPLE OUT OF RANGE!', {
                                endSample,
                                audioBufferLength: audioBuffer.length
                            });
                            // Adjust endSample to not exceed buffer length
                            const adjustedEndSample = audioBuffer.length;
                            const adjustedSampleCount = adjustedEndSample - startSample;
                            console.log('🔧 调整采样范围 ADJUSTING SAMPLE RANGE:', {
                                oldEndSample: endSample,
                                newEndSample: adjustedEndSample,
                                newSampleCount: adjustedSampleCount
                            });
                        }
                        
                        const finalEndSample = Math.min(endSample, audioBuffer.length);
                        const finalSampleCount = finalEndSample - startSample;
                        
                        if (finalSampleCount <= 0) {
                            console.log('🚨 跳过无效分块 SKIPPING INVALID CHUNK:', finalSampleCount);
                            continue;
                        }
                        
                        const chunkBuffer = audioContext.createBuffer(
                            audioBuffer.numberOfChannels,
                            finalSampleCount,
                            sampleRate
                        );
                        
                        for (let channel = 0; channel < audioBuffer.numberOfChannels; channel++) {
                            const channelData = audioBuffer.getChannelData(channel);
                            const chunkData = chunkBuffer.getChannelData(channel);
                            for (let j = 0; j < finalSampleCount; j++) {
                                chunkData[j] = channelData[startSample + j];
                            }
                        }
                        
                        const wavBlob = this.audioBufferToWav(chunkBuffer);
                        
                        chunks.push({
                            blob: wavBlob,
                            index: i,
                            startTime: startTime,
                            endTime: endTime,
                            duration: chunkDuration
                        });
                        
                        console.log(`✅ 录音分块 ${i + 1} 创建完成 RECORDING CHUNK ${i + 1} CREATED: ${chunkDuration.toFixed(1)}s, ${wavBlob.size} bytes`);
                    }
                    
                    resolve(chunks);
                } catch (error) {
                    console.log('💥 录音分块创建失败 RECORDING CHUNK CREATION FAILED:', error);
                    reject(error);
                }
            };
            
            reader.onerror = reject;
            reader.readAsArrayBuffer(blob);
        });
    }
    
    showTranscriptionResult(result) {
        const transcriptionText = document.getElementById('transcriptionText');
        const confidenceScore = document.getElementById('confidenceScore');
        
        transcriptionText.textContent = result.transcript;
        
        if (result.confidence) {
            const confidencePercent = Math.round(result.confidence * 100);
            let confidenceText = `(Confidence: ${confidencePercent}%)`;
            
            // Add chunking information if applicable
            if (result.chunked) {
                confidenceText += ` | Processed in ${result.chunkCount} chunks`;
            } else if (result.fallback) {
                confidenceText += ` | Used fallback method`;
            }
            
            confidenceScore.textContent = confidenceText;
            confidenceScore.style.color = confidencePercent > 80 ? 'var(--warm-success)' : 
                                        confidencePercent > 60 ? 'var(--warm-warning)' : 
                                        'var(--warm-danger)';
        }
        
        // Handle Gemini AI analysis results
        this.showGeminiResults(result.gemini);
        
        document.getElementById('transcriptionResult').classList.remove('d-none');
        
        // Add event listeners for transcription buttons
        document.getElementById('saveTranscription').onclick = () => this.saveStoryWithTranscription();
        document.getElementById('retranscribe').onclick = () => this.transcribeAudio();
    }
    

    
    showTranscriptionError(error) {
        // Ensure transcription section is visible first
        this.showTranscriptionSection();
        
        const errorTextElement = document.getElementById('transcriptionErrorText');
        const errorElement = document.getElementById('transcriptionError');
        const retryButton = document.getElementById('retryTranscription');
        
        if (errorTextElement && errorElement) {
            errorTextElement.textContent = error;
            errorElement.classList.remove('d-none');
        
        // Add retry button event listener
            if (retryButton) {
                retryButton.onclick = () => {
                    errorElement.classList.add('d-none');
                    this.retryTranscription();
                };
            }
        } else {
            // Fallback: show error in browser alert if DOM elements don't exist
            console.error('Transcription Error:', error);
            this.showError('Transcription failed: ' + error);
        }
    }
    
    retryTranscription() {
        // Determine which transcription method to retry based on current mode
        if (this.recordingMode === 'upload' && this.uploadedFile) {
            this.transcribeUploadedFile();
        } else {
            this.transcribeAudio();
        }
    }
    
    async saveStoryWithTranscription() {
        const transcriptionText = document.getElementById('transcriptionText').textContent;
        const selectedLanguage = this.selectedLanguage;
        
        // TODO: Save both audio and transcription to database
        alert(`故事已保存！| Story saved!\n语言 | Language: ${selectedLanguage}\n转录 | Transcription: ${transcriptionText.substring(0, 100)}...`);
        
        // Reset the recorder for a new recording
        this.recordAgain();
        document.getElementById('transcriptionSection').classList.add('d-none');
    }

    startTranscription() {
        // Show transcription section and start transcribing
        this.showTranscriptionSection();
        this.transcribeAudio();
    }
    
    saveRecording() {
        // TODO: Save audio only to database
        alert('录音已保存！您可以点击"开始Google识别"来获取文字转录。\n\nAudio saved! You can click "Start Google Recognition" to get text transcription.');
    }
    
    discardRecording() {
        if (confirm('Are you sure you want to discard this recording?')) {
            this.recordAgain();
        }
    }
    
    recordAgain() {
        if (this.audioElement) {
            this.audioElement.pause();
            URL.revokeObjectURL(this.audioElement.src);
        }
        
        this.audioChunks = [];
        this.recordedBlob = null;
        this.playbackSection.classList.add('d-none');
        this.startBtn.classList.remove('d-none');
        this.recordingTime.textContent = '00:00';
        
        // Hide transcription section
        document.getElementById('transcriptionSection').classList.add('d-none');
    }
    
    startTimer() {
        this.timerInterval = setInterval(() => {
            if (!this.isPaused) {
                const elapsed = Date.now() - this.startTime - this.pausedDuration;
                this.recordingTime.textContent = this.formatTime(elapsed / 1000);
            } else {
                const elapsed = this.pauseStartTime - this.startTime - this.pausedDuration;
                this.pausedTime.textContent = this.formatTime(elapsed / 1000);
            }
        }, 1000);
    }
    
    stopTimer() {
        if (this.timerInterval) {
            clearInterval(this.timerInterval);
            this.timerInterval = null;
        }
    }
    
    startVisualization() {
        const canvas = this.audioVisualizer;
        const ctx = canvas.getContext('2d');
        const bufferLength = this.analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        
        const draw = () => {
            this.animationFrame = requestAnimationFrame(draw);
            
            this.analyser.getByteFrequencyData(dataArray);
            
            ctx.fillStyle = '#FFF8E1';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const barWidth = (canvas.width / bufferLength) * 2.5;
            let barHeight;
            let x = 0;
            
            for (let i = 0; i < bufferLength; i++) {
                barHeight = (dataArray[i] / 255) * canvas.height * 0.8;
                
                const gradient = ctx.createLinearGradient(0, canvas.height - barHeight, 0, canvas.height);
                gradient.addColorStop(0, '#FF8A65');
                gradient.addColorStop(1, '#E64A19');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                
                x += barWidth + 1;
            }
        };
        
        draw();
    }
    
    stopVisualization() {
        if (this.animationFrame) {
            cancelAnimationFrame(this.animationFrame);
            this.animationFrame = null;
        }
    }
    
    formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    
    showStatus(message, type) {
        this.micStatus.style.display = 'block';
        this.micStatus.className = `alert alert-${type}`;
        this.micStatusText.textContent = message;
        
        if (type === 'success') {
            setTimeout(() => {
                this.micStatus.style.display = 'none';
            }, 3000);
        }
    }
    
    // Chat functionality methods
    async sendChatMessage() {
        const message = this.chatInput.value.trim();
        if (!message) return;
        
        if (!this.currentStoryText) {
            this.showError('No story available for chat. Please record and transcribe a story first.');
            return;
        }
        
        // Clear input and show loading
        this.chatInput.value = '';
        this.sendChatBtn.disabled = true;
        this.chatLoading.classList.remove('d-none');
        
        try {
            // Add user message to chat history
            this.addChatMessage('user', message);
            
            console.log('🤖 === 发送聊天消息 SENDING CHAT MESSAGE ===');
            console.log('Message:', message);
            console.log('Current story length:', this.currentStoryText.length);
            console.log('Chat history length:', this.chatMessages.length);
            
            // Prepare chat request
            const chatData = {
                message: message,
                current_story: this.currentStoryText,
                chat_history: this.chatMessages.slice(-10), // Last 10 messages for context
                language: this.selectedLanguageCode
            };
            
            console.log('📤 发送聊天API请求 SENDING CHAT API REQUEST:', chatData);
            
            const response = await fetch('/api/chat-with-gemini', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(chatData)
            });
            
            console.log('📨 聊天API响应状态 CHAT API RESPONSE STATUS:', response.status);
            
            const result = await response.json();
            
            console.log('📋 聊天API响应结果 CHAT API RESPONSE:', result);
            
            if (result.success) {
                // Add AI response to chat history
                this.addChatMessage('assistant', result.gemini_response);
                
                // Check if the response contains a revised story
                if (this.isRevisedStory(result.gemini_response)) {
                    this.updatePolishedStory(result.gemini_response);
                }
                
                console.log('✅ 聊天成功 CHAT SUCCESS');
                
            } else {
                console.log('❌ 聊天失败 CHAT FAILED:', result.error);
                this.addChatMessage('system', `Error: ${result.error}`);
            }
            
        } catch (error) {
            console.log('💥 聊天异常 CHAT ERROR:', error);
            this.addChatMessage('system', `Network error: ${error.message}`);
        } finally {
            this.sendChatBtn.disabled = false;
            this.chatLoading.classList.add('d-none');
        }
    }
    
    addChatMessage(role, content) {
        // Hide placeholder if this is the first message
        if (this.chatMessages.length === 0) {
            this.chatPlaceholder.style.display = 'none';
        }
        
        // Add to message history
        this.chatMessages.push({
            role: role,
            content: content,
            timestamp: new Date().toISOString()
        });
        
        // Create message element
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message mb-3 ${role}`;
        
        let avatarIcon, roleLabel, messageClass;
        if (role === 'user') {
            avatarIcon = 'fas fa-user';
            roleLabel = '您 | You';
            messageClass = 'user-message';
        } else if (role === 'assistant') {
            avatarIcon = 'fas fa-robot';
            roleLabel = 'AI助手 | AI Assistant';
            messageClass = 'ai-message';
        } else {
            avatarIcon = 'fas fa-exclamation-triangle';
            roleLabel = '系统 | System';
            messageClass = 'system-message';
        }
        
        messageDiv.innerHTML = `
            <div class="d-flex ${role === 'user' ? 'justify-content-end' : 'justify-content-start'}">
                <div class="message-bubble ${messageClass}" style="max-width: 80%; padding: 10px 15px; border-radius: 15px; ${role === 'user' ? 'background: var(--warm-primary); color: white; margin-left: 20%;' : 'background: #f8f9fa; border: 1px solid #dee2e6; margin-right: 20%;'}">
                    <div class="message-header mb-1">
                        <small class="text-muted">
                            <i class="${avatarIcon} me-1"></i>
                            ${roleLabel}
                        </small>
                    </div>
                    <div class="message-content" style="line-height: 1.5; white-space: pre-wrap;">${content}</div>
                </div>
            </div>
        `;
        
        // Add to chat history
        this.chatHistory.appendChild(messageDiv);
        
        // Scroll to bottom
        this.chatHistory.scrollTop = this.chatHistory.scrollHeight;
        
        // Add animation
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translateY(20px)';
        setTimeout(() => {
            messageDiv.style.transition = 'all 0.3s ease';
            messageDiv.style.opacity = '1';
            messageDiv.style.transform = 'translateY(0)';
        }, 50);
    }
    
    isRevisedStory(response) {
        // Simple heuristic to detect if the response contains a revised story
        // You can make this more sophisticated based on your needs
        const storyIndicators = [
            'here is the revised story',
            'here\'s the improved version',
            'revised story:',
            'improved story:',
            'new version:',
            'here\'s the story',
            'updated story'
        ];
        
        const lowerResponse = response.toLowerCase();
        return storyIndicators.some(indicator => lowerResponse.includes(indicator)) ||
               (response.length > 100 && response.includes('.') && !response.startsWith('I think') && !response.startsWith('You could'));
    }
    
    updatePolishedStory(newStoryText) {
        // Update the current story text
        this.currentStoryText = newStoryText;
        
        // Update the polished story display
        const polishedStoryElement = document.getElementById('polishedStoryText');
        if (polishedStoryElement) {
            polishedStoryElement.textContent = newStoryText;
            
            // Add update animation
            polishedStoryElement.style.transition = 'background-color 0.5s ease';
            polishedStoryElement.style.backgroundColor = '#fff3cd';
            setTimeout(() => {
                polishedStoryElement.style.backgroundColor = '';
            }, 1500);
        }
    }
    
    // Modified showTranscriptionResult to handle polished stories
    showTranscriptionResult(result) {
        console.log('📋 显示转录结果 SHOWING TRANSCRIPTION RESULT:', result);
        
        const transcriptionText = document.getElementById('transcriptionText');
        const polishedStoryText = document.getElementById('polishedStoryText');
        const rawTranscriptionText = document.getElementById('rawTranscriptionText');
        const confidenceScore = document.getElementById('confidenceScore');
        const geminiModelUsed = document.getElementById('geminiModelUsed');
        const polishedIndicator = document.getElementById('polishedIndicator');
        
        // Determine if we have a polished version
        let displayText = result.transcript || '';
        let rawText = result.raw_transcript || '';
        let isPolished = result.polished || false;
        
        // 🔍 DEBUG: 详细调试原始转录问题
        console.log('🔍 Raw transcript debug:', {
            'result object keys': Object.keys(result),
            'result.raw_transcript': result.raw_transcript,
            'result.raw_transcript type': typeof result.raw_transcript,
            'result.raw_transcript length': result.raw_transcript ? result.raw_transcript.length : 'undefined',
            'rawText': rawText,
            'rawText type': typeof rawText,
            'rawText length': rawText ? rawText.length : 'undefined',
            'result.transcript': result.transcript ? result.transcript.substring(0, 50) + '...' : 'undefined'
        });
        
        // Ensure we have actual raw transcript, not polished fallback
        if (!rawText && result.transcript) {
            console.warn('⚠️ Warning: No raw transcript available, showing placeholder message');
        }
        
        // Store current story for chat
        this.currentStoryText = displayText;
        this.selectedLanguageCode = result.language || 'en-US';
        
        // Update the main story display (polished version)
        if (polishedStoryText) {
            polishedStoryText.textContent = displayText;
        }
        
        // Update raw transcription (collapsible section)
        if (rawTranscriptionText) {
            if (rawText) {
                rawTranscriptionText.textContent = rawText;
                rawTranscriptionText.style.fontStyle = 'normal';
                rawTranscriptionText.style.color = '#6c757d';
            } else {
                rawTranscriptionText.textContent = '原始转录不可用 | Raw transcription not available';
                rawTranscriptionText.style.fontStyle = 'italic';
                rawTranscriptionText.style.color = '#adb5bd';
            }
        }
        
        // Update confidence score
        if (confidenceScore && result.confidence) {
            const confidence = (result.confidence * 100).toFixed(1);
            confidenceScore.innerHTML = `<strong>置信度 | Confidence: ${confidence}%</strong>`;
        }
        
        // Update Gemini model info
        if (geminiModelUsed && result.gemini?.model) {
            geminiModelUsed.textContent = result.gemini.model;
            document.getElementById('geminiModelUsedEn').textContent = result.gemini.model;
        }
        
        // Update polished indicator
        if (polishedIndicator) {
            if (isPolished) {
                polishedIndicator.className = 'badge bg-success ms-2';
                polishedIndicator.innerHTML = '<i class="fas fa-check me-1"></i>已润色 | Polished';
            } else {
                polishedIndicator.className = 'badge bg-warning ms-2';
                polishedIndicator.innerHTML = '<i class="fas fa-exclamation me-1"></i>未润色 | Not Polished';
            }
        }
        

        
        // Show the transcription result section
        document.getElementById('transcriptionResult').classList.remove('d-none');
        
        // Show publish button if story is polished
        if (isPolished && this.currentStoryText) {
            document.getElementById('publishStoryBtn').style.display = 'inline-block';
        }
        
        console.log('✅ 转录结果显示完成 TRANSCRIPTION RESULT DISPLAY COMPLETE');
        console.log('Story available for chat:', !!this.currentStoryText);
    }


    
    showError(message) {
        document.getElementById('errorMessage').textContent = message;
        const modal = new bootstrap.Modal(document.getElementById('errorModal'));
        modal.show();
    }
    
    getLanguageName(languageCode) {
        const languages = {
            'en-US': 'English (US)',
            'zh-CN': '中文 (简体)',
            'zh-TW': '中文 (繁體)',
            'ja-JP': '日本語',
            'ko-KR': '한국어',
            'es-ES': 'Español',
            'fr-FR': 'Français',
            'de-DE': 'Deutsch',
            'it-IT': 'Italiano',
            'pt-BR': 'Português (Brasil)',
            'ru-RU': 'Русский',
            'ar-SA': 'العربية',
            'hi-IN': 'हिन्दी',
            'th-TH': 'ไทย',
            'vi-VN': 'Tiếng Việt'
        };
        return languages[languageCode] || languageCode;
    }
}

// Initialize dynamic styles
const style = document.createElement('style');
style.textContent = `
    .recording-pulse {
        width: 15px;
        height: 15px;
        background: #E64A19;
        border-radius: 50%;
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
    }
    
    /* Language Selector Styles */
    .language-selector-container {
        transition: all 0.3s ease;
    }
    
    .language-selector-container:hover {
        border-color: var(--warm-primary) !important;
        box-shadow: 0 4px 15px rgba(255, 138, 101, 0.2);
    }
    
    .selected-language {
        transition: background-color 0.2s ease;
    }
    
    .selected-language:hover {
        background-color: #f8f9fa;
    }
    
    .dropdown-arrow {
        transition: transform 0.3s ease;
        color: var(--warm-secondary);
    }
    
    .language-option {
        transition: all 0.2s ease;
        border-bottom: 1px solid #eee !important;
    }
    
    .language-option:hover {
        background-color: var(--warm-primary-light);
        color: var(--warm-primary-dark);
        transform: translateX(4px);
    }
    
    .language-option:last-child {
        border-bottom: none !important;
        border-radius: 0 0 13px 13px;
    }
    
    .language-dropdown {
        border-top: 1px solid #eee !important;
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .language-dropdown::-webkit-scrollbar {
        width: 8px;
    }
    
    .language-dropdown::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    .language-dropdown::-webkit-scrollbar-thumb {
        background: var(--warm-primary);
        border-radius: 4px;
    }
    
    .language-dropdown::-webkit-scrollbar-thumb:hover {
        background: var(--warm-primary-dark);
    }
    
    #languageSearch {
        transition: all 0.3s ease;
    }
    
    #languageSearch:focus {
        border-color: var(--warm-primary) !important;
        box-shadow: 0 0 0 0.2rem rgba(255, 138, 101, 0.25) !important;
        outline: none;
    }
    
    .flag {
        font-size: 1.2em;
        display: inline-block;
    }
    
    /* File Upload Styles */
    .upload-area {
        transition: all 0.3s ease;
    }
    
    .upload-area:hover {
        border-color: var(--warm-primary) !important;
        box-shadow: 0 8px 25px rgba(255, 138, 101, 0.2);
        transform: translateY(-2px);
    }
    
    .upload-area.drag-over {
        border-color: var(--warm-primary) !important;
        background-color: #FFF8E1 !important;
        transform: scale(1.02);
    }
`;

// Add dynamic styles to page
document.head.appendChild(style);

// Global variable to store recorder instance
window.storyRecorder = null;

// Initialize recorder when page loads
document.addEventListener('DOMContentLoaded', () => {
    window.storyRecorder = new VoiceRecorder();
});
</script>

<style>
.file-info {
    animation: fadeInUp 0.5s ease;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.audio-preview audio {
    border: 2px solid var(--warm-neutral);
    border-radius: 15px;
    outline: none;
}

.audio-preview audio:focus {
    border-color: var(--warm-primary);
    box-shadow: 0 0 0 0.2rem rgba(255, 138, 101, 0.25);
}

.file-actions .btn {
    border-radius: 25px;
    padding: 12px 24px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.file-actions .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

.upload-progress {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Recording Mode Toggle Styles */
.btn-group .btn-check:checked + .btn {
    background-color: var(--warm-primary);
    border-color: var(--warm-primary);
    color: white;
}

.btn-group .btn {
    transition: all 0.3s ease;
    font-weight: 600;
    padding: 12px 24px;
}

.btn-group .btn:hover {
    background-color: var(--warm-primary-light);
    border-color: var(--warm-primary);
    color: var(--warm-primary-dark);
}
</style>

<script>
// Story publishing functionality
function goToPublish() {
    // Get current story data
    const recorder = window.storyRecorder;
    if (!recorder || !recorder.currentStoryText) {
        alert('没有可发布的故事内容 | No story content to publish');
        return;
    }
    
    // Prepare story data for publishing
    const storyData = {
        transcription: recorder.originalTranscription || '',
        polished_content: recorder.currentStoryText || '',
        language: recorder.selectedLanguage || 'zh-CN',
        language_name: recorder.getLanguageName(recorder.selectedLanguage) || '中文',
        timestamp: new Date().toISOString()
    };
    
    // Store in session storage for publish page
    sessionStorage.setItem('recordedStory', JSON.stringify(storyData));
    
    // Navigate to publish page
    window.location.href = '/publish_story';
}

// Update publish button visibility when story is edited
document.addEventListener('DOMContentLoaded', function() {
    const polishedStoryText = document.getElementById('polishedStoryText');
    if (polishedStoryText) {
        polishedStoryText.addEventListener('input', function() {
            // Update the current story text in recorder
            if (window.storyRecorder) {
                window.storyRecorder.currentStoryText = this.textContent;
                
                // Show publish button if there's content
                const publishBtn = document.getElementById('publishStoryBtn');
                if (this.textContent.trim()) {
                    publishBtn.style.display = 'inline-block';
                } else {
                    publishBtn.style.display = 'none';
                }
            }
        });
    }
});
</script>

<style>
.file-info {
    animation: fadeInUp 0.5s ease;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.audio-preview audio {
    border: 2px solid var(--warm-neutral);
    border-radius: 15px;
    outline: none;
}

.audio-preview audio:focus {
    border-color: var(--warm-primary);
    box-shadow: 0 0 0 0.2rem rgba(255, 138, 101, 0.25);
}

.file-actions .btn {
    border-radius: 25px;
    padding: 12px 24px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.file-actions .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

.upload-progress {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Recording Mode Toggle Styles */
.btn-group .btn-check:checked + .btn {
    background-color: var(--warm-primary);
    border-color: var(--warm-primary);
    color: white;
}

.btn-group .btn {
    transition: all 0.3s ease;
    font-weight: 600;
    padding: 12px 24px;
}

.btn-group .btn:hover {
    background-color: var(--warm-primary-light);
    border-color: var(--warm-primary);
    color: var(--warm-primary-dark);
}
</style>

{% endblock %} 