{% extends "base.html" %}

{% block title %}User Management - 
echoverse
 Admin{% endblock %}

{% block content %}
<!-- Admin Header -->
<div class="bg-gradient-primary text-white py-4 mb-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h3 mb-0 text-white">
                    <i class="fas fa-users me-3"></i>
                    User Management
                </h1>
                <p class="mb-0 mt-2 opacity-75">Manage registered users and their accounts</p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="d-flex justify-content-md-end gap-2">
                    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                    <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Filter and Search -->
    <div class="card border-0 shadow-warm mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Search Users</label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search by username or email...">
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Filter by Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">All Users</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Sort by</label>
                    <select class="form-select" id="sortFilter">
                        <option value="created_at">Registration Date</option>
                        <option value="username">Username</option>
                        <option value="email">Email</option>
                        <option value="last_login">Last Login</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="applyFilters()">
                        <i class="fas fa-filter me-2"></i>Filter
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Statistics -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-warm h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-users" style="font-size: 2rem; color: var(--color-primary);"></i>
                    </div>
                    <h4 class="mb-2">{{ stats.total_users }}</h4>
                    <p class="text-muted mb-0">Total Users</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-warm h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-user-check" style="font-size: 2rem; color: #16a34a;"></i>
                    </div>
                    <h4 class="mb-2">{{ stats.active_users }}</h4>
                    <p class="text-muted mb-0">Active Users</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-warm h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-calendar-day" style="font-size: 2rem; color: #0ea5e9;"></i>
                    </div>
                    <h4 class="mb-2">{{ stats.new_users_today }}</h4>
                    <p class="text-muted mb-0">New Today</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-warm h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-clock" style="font-size: 2rem; color: #f59e0b;"></i>
                    </div>
                    <h4 class="mb-2">{{ stats.online_users }}</h4>
                    <p class="text-muted mb-0">Online Now</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="card border-0 shadow-warm">
        <div class="card-header bg-light border-0 d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-list me-2 text-primary"></i>
                User List
            </h5>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" onclick="refreshTable()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="exportUsers()">
                    <i class="fas fa-download me-1"></i>Export
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="px-4 py-3">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th class="px-4 py-3">User</th>
                            <th class="px-4 py-3">Email</th>
                            <th class="px-4 py-3">Stories</th>
                            <th class="px-4 py-3">Status</th>
                            <th class="px-4 py-3">Registered</th>
                            <th class="px-4 py-3">Last Login</th>
                            <th class="px-4 py-3 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        {% for user in users %}
                        <tr data-user-id="{{ user.id }}">
                            <td class="px-4 py-3">
                                <input type="checkbox" class="user-checkbox" value="{{ user.id }}">
                            </td>
                            <td class="px-4 py-3">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle me-3">
                                        {{ user.username[:1].upper() }}
                                    </div>
                                    <div>
                                        <div class="fw-semibold">{{ user.username }}</div>
                                        <small class="text-muted">ID: {{ user.id }}</small>
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-3">
                                <span class="text-muted">{{ user.email or 'No email' }}</span>
                            </td>
                            <td class="px-4 py-3">
                                <span class="badge bg-info">{{ user.story_count or 0 }} stories</span>
                            </td>
                            <td class="px-4 py-3">
                                <span class="badge {{ 'bg-success' if user.is_active else 'bg-secondary' }}">
                                    {{ 'Active' if user.is_active else 'Inactive' }}
                                </span>
                            </td>
                            <td class="px-4 py-3">
                                <small class="text-muted">
                                    {{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else 'Unknown' }}
                                </small>
                            </td>
                            <td class="px-4 py-3">
                                <small class="text-muted">
                                    {{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}
                                </small>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                        Actions
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="viewUser({{ user.id }})">
                                            <i class="fas fa-eye me-2"></i>View Details
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="resetPassword({{ user.id }})">
                                            <i class="fas fa-key me-2"></i>Reset Password
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="toggleUserStatus({{ user.id }}, {{ 'false' if user.is_active else 'true' }})">
                                            <i class="fas fa-{{ 'ban' if user.is_active else 'check' }} me-2"></i>{{ 'Deactivate' if user.is_active else 'Activate' }}
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteUser({{ user.id }})">
                                            <i class="fas fa-trash me-2"></i>Delete User
                                        </a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Pagination -->
        {% if pagination.pages > 1 %}
        <div class="card-footer bg-light border-0">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted">
                    Showing {{ (pagination.page - 1) * pagination.per_page + 1 }} to 
                    {{ min(pagination.page * pagination.per_page, pagination.total) }} of 
                    {{ pagination.total }} users
                </div>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        {% if pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ pagination.prev_num }}">Previous</a>
                        </li>
                        {% endif %}
                        
                        {% for page_num in pagination.iter_pages() %}
                        {% if page_num %}
                        {% if page_num != pagination.page %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                        </li>
                        {% else %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                        {% endif %}
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                        {% endif %}
                        {% endfor %}
                        
                        {% if pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ pagination.next_num }}">Next</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Batch Actions -->
    <div class="card border-0 shadow-warm mt-4" id="batchActions" style="display: none;">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span id="selectedCount">0</span> users selected
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-warning btn-sm" onclick="batchToggleStatus()">
                        <i class="fas fa-toggle-on me-1"></i>Toggle Status
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="batchDelete()">
                        <i class="fas fa-trash me-1"></i>Delete Selected
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Detail Modal -->
<div class="modal fade" id="userDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userDetailContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reset User Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    This will generate a new temporary password for the user.
                </div>
                <div class="mb-3">
                    <label class="form-label">New Password</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="newPassword" placeholder="Enter new password or generate one">
                        <button class="btn btn-outline-secondary" onclick="generatePassword()">
                            <i class="fas fa-sync-alt me-1"></i>Generate
                        </button>
                        <button class="btn btn-outline-secondary" onclick="copyPassword()">
                            <i class="fas fa-copy me-1"></i>Copy
                        </button>
                    </div>
                    <div class="form-text">You can type a custom password or use the Generate button for a random one.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmPasswordReset()">Reset Password</button>
            </div>
        </div>
    </div>
</div>

<style>
.avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--color-primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.1rem;
}

.table th {
    font-weight: 600;
    color: var(--color-text-primary);
    border-bottom: 2px solid #e5e7eb;
}

.table td {
    vertical-align: middle;
    border-bottom: 1px solid #f3f4f6;
}

.table tbody tr:hover {
    background-color: #f8fafc;
}

.dropdown-menu {
    border: none;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.pagination .page-link {
    border: none;
    color: var(--color-primary);
}

.pagination .page-item.active .page-link {
    background-color: var(--color-primary);
    border-color: var(--color-primary);
}
</style>

<script>
let selectedUsers = new Set();
let currentUserId = null;

// Toggle select all checkboxes
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.user-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        if (selectAll.checked) {
            selectedUsers.add(parseInt(checkbox.value));
        } else {
            selectedUsers.delete(parseInt(checkbox.value));
        }
    });
    
    updateBatchActions();
}

// Handle individual checkbox changes
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('user-checkbox')) {
        const userId = parseInt(e.target.value);
        if (e.target.checked) {
            selectedUsers.add(userId);
        } else {
            selectedUsers.delete(userId);
        }
        updateBatchActions();
    }
});

// Update batch actions visibility
function updateBatchActions() {
    const batchActions = document.getElementById('batchActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedUsers.size > 0) {
        batchActions.style.display = 'block';
        selectedCount.textContent = selectedUsers.size;
    } else {
        batchActions.style.display = 'none';
    }
}

// View user details
function viewUser(userId) {
    fetch(`/admin/api/user/${userId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const user = data.user;
                document.getElementById('userDetailContent').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Basic Information</h6>
                            <dl class="row">
                                <dt class="col-sm-4">Username:</dt>
                                <dd class="col-sm-8">${user.username}</dd>
                                <dt class="col-sm-4">Email:</dt>
                                <dd class="col-sm-8">${user.email || 'Not provided'}</dd>
                                <dt class="col-sm-4">Status:</dt>
                                <dd class="col-sm-8">
                                    <span class="badge ${user.is_active ? 'bg-success' : 'bg-secondary'}">
                                        ${user.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                </dd>
                                <dt class="col-sm-4">Registered:</dt>
                                <dd class="col-sm-8">${new Date(user.created_at).toLocaleString()}</dd>
                                <dt class="col-sm-4">Last Login:</dt>
                                <dd class="col-sm-8">${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <h6>Activity Statistics</h6>
                            <dl class="row">
                                <dt class="col-sm-6">Total Stories:</dt>
                                <dd class="col-sm-6">${user.total_stories}</dd>
                                <dt class="col-sm-6">Published:</dt>
                                <dd class="col-sm-6">${user.published_stories}</dd>
                                <dt class="col-sm-6">Pending:</dt>
                                <dd class="col-sm-6">${user.pending_stories}</dd>
                                <dt class="col-sm-6">Total Views:</dt>
                                <dd class="col-sm-6">${user.total_views}</dd>
                            </dl>
                        </div>
                    </div>
                `;
                new bootstrap.Modal(document.getElementById('userDetailModal')).show();
            } else {
                alert('Failed to load user details: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while loading user details');
        });
}

// Reset user password
function resetPassword(userId) {
    currentUserId = userId;
    // Clear the password field to allow manual input
    document.getElementById('newPassword').value = '';
    new bootstrap.Modal(document.getElementById('resetPasswordModal')).show();
}

// Generate random password
function generatePassword() {
    const length = 12;
    const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
    let password = "";
    for (let i = 0; i < length; i++) {
        password += charset.charAt(Math.floor(Math.random() * charset.length));
    }
    document.getElementById('newPassword').value = password;
}

// Copy password to clipboard
function copyPassword() {
    const passwordField = document.getElementById('newPassword');
    passwordField.select();
    document.execCommand('copy');
    
    // Show feedback
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
    setTimeout(() => {
        button.innerHTML = originalText;
    }, 2000);
}

// Confirm password reset
function confirmPasswordReset() {
    const newPassword = document.getElementById('newPassword').value.trim();
    
    if (!newPassword) {
        alert('Please enter a password or generate one');
        return;
    }
    
    if (newPassword.length < 6) {
        alert('Password must be at least 6 characters long');
        return;
    }
    
    fetch(`/admin/api/reset_user_password/${currentUserId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            new_password: newPassword
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Password reset successfully!');
            bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal')).hide();
        } else {
            alert('Failed to reset password: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while resetting password');
    });
}

// Toggle user status
function toggleUserStatus(userId, newStatus) {
    const action = newStatus === 'true' ? 'activate' : 'deactivate';
    
    if (!confirm(`Are you sure you want to ${action} this user?`)) {
        return;
    }
    
    fetch(`/admin/api/toggle_user_status/${userId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            status: newStatus === 'true'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`User ${action}d successfully!`);
            location.reload();
        } else {
            alert(`Failed to ${action} user: ` + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(`An error occurred while ${action}ing user`);
    });
}

// Delete user
function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user? This action cannot be undone and will also delete all their stories.')) {
        return;
    }
    
    fetch(`/admin/api/delete_user/${userId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('User deleted successfully!');
            location.reload();
        } else {
            alert('Failed to delete user: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting user');
    });
}

// Batch operations
function batchToggleStatus() {
    if (selectedUsers.size === 0) {
        alert('Please select users first');
        return;
    }
    
    if (!confirm(`Toggle status for ${selectedUsers.size} selected users?`)) {
        return;
    }
    
    fetch('/admin/api/batch_user_action', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'toggle_status',
            user_ids: Array.from(selectedUsers)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Status toggled for ${data.affected_count} users`);
            location.reload();
        } else {
            alert('Batch operation failed: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred during batch operation');
    });
}

function batchDelete() {
    if (selectedUsers.size === 0) {
        alert('Please select users first');
        return;
    }
    
    if (!confirm(`Delete ${selectedUsers.size} selected users? This action cannot be undone and will also delete all their stories.`)) {
        return;
    }
    
    fetch('/admin/api/batch_user_action', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'delete',
            user_ids: Array.from(selectedUsers)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${data.affected_count} users deleted successfully`);
            location.reload();
        } else {
            alert('Batch deletion failed: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred during batch deletion');
    });
}

// Filter and search functions
function applyFilters() {
    const search = document.getElementById('searchInput').value;
    const status = document.getElementById('statusFilter').value;
    const sort = document.getElementById('sortFilter').value;
    
    const params = new URLSearchParams();
    if (search) params.append('search', search);
    if (status) params.append('status', status);
    if (sort) params.append('sort', sort);
    
    window.location.href = `${window.location.pathname}?${params.toString()}`;
}

function refreshTable() {
    location.reload();
}

function exportUsers() {
    window.open('/admin/api/export_users', '_blank');
}

// Auto-search on input
document.getElementById('searchInput').addEventListener('input', function() {
    clearTimeout(this.searchTimeout);
    this.searchTimeout = setTimeout(() => {
        applyFilters();
    }, 500);
});
</script>
{% endblock %}